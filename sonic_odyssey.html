<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è²æ§é£›æ¢­ - Sonic Odyssey</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            margin: 0;
            overflow: hidden;
            background-color: #0f172a;
            color: white;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            touch-action: none;
            user-select: none;
        }
        canvas {
            display: block;
            width: 100%;
            height: 100%;
        }
        .ui-layer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            padding: 16px;
            box-sizing: border-box;
            z-index: 10;
        }
        .interactive {
            pointer-events: auto;
        }
        /* Glassmorphism Panel */
        .panel {
            background: rgba(15, 23, 42, 0.9);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(56, 189, 248, 0.3);
            border-radius: 16px;
            padding: 1.5rem;
            max-width: 500px;
            width: 95%;
            margin: 0 auto;
            text-align: center;
            box-shadow: 0 0 30px rgba(56, 189, 248, 0.15);
            transition: all 0.3s ease;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        /* Custom UI Elements */
        input[type=range] {
            -webkit-appearance: none;
            width: 100%;
            background: transparent;
            cursor: pointer;
        }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 16px;
            width: 16px;
            border-radius: 50%;
            background: #38bdf8;
            margin-top: -6px;
            box-shadow: 0 0 8px #38bdf8;
            transition: transform 0.1s;
        }
        input[type=range]::-webkit-slider-thumb:hover { transform: scale(1.2); }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%;
            height: 4px;
            background: #334155;
            border-radius: 2px;
        }
        
        /* Radio Selection */
        .radio-group label { cursor: pointer; transition: all 0.2s; }
        .radio-group input:checked + div {
            background-color: rgba(56, 189, 248, 0.2);
            border-color: #38bdf8;
            color: #38bdf8;
            box-shadow: 0 0 10px rgba(56, 189, 248, 0.2);
        }
        /* Difficulty Colors */
        .diff-group input[value="easy"]:checked + div { border-color: #22c55e; color: #22c55e; background-color: rgba(34, 197, 94, 0.2); }
        .diff-group input[value="medium"]:checked + div { border-color: #f59e0b; color: #f59e0b; background-color: rgba(245, 158, 11, 0.2); }
        .diff-group input[value="hard"]:checked + div { border-color: #ef4444; color: #ef4444; background-color: rgba(239, 68, 68, 0.2); }

        /* Scrollbar */
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: rgba(0,0,0,0.1); }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: rgba(56, 189, 248, 0.3); border-radius: 3px; }

        .tutorial-section h4 {
            color: #38bdf8; font-weight: bold; margin-bottom: 0.5rem;
            border-bottom: 1px solid rgba(56, 189, 248, 0.3); padding-bottom: 0.2rem; text-align: left;
        }
        .tutorial-section p {
            text-align: left; font-size: 0.85rem; color: #cbd5e1; margin-bottom: 0.8rem; line-height: 1.4;
        }
        
        /* Damage Flash Animation */
        @keyframes flashRed {
            0% { background-color: rgba(239, 68, 68, 0.5); }
            100% { background-color: transparent; }
        }
        .damage-flash {
            animation: flashRed 0.3s ease-out;
        }
    </style>
</head>
<body>

    <canvas id="gameCanvas"></canvas>
    
    <!-- Damage Flash Overlay -->
    <div id="damageOverlay" class="absolute inset-0 pointer-events-none z-0"></div>

    <div class="ui-layer">
        
        <!-- HUD (Top Bar) -->
        <div id="hud" class="flex justify-between items-start w-full opacity-0 transition-opacity duration-500 pointer-events-none">
            <!-- Left: HP & Score -->
            <div class="hud-text flex flex-col items-start gap-2">
                <!-- HP Bar -->
                <div class="w-48 h-5 bg-slate-800 rounded-full overflow-hidden border border-slate-600 relative shadow-lg">
                    <div id="hpBar" class="h-full bg-green-500 transition-all duration-300 w-full"></div>
                    <div class="absolute inset-0 flex items-center justify-center text-[10px] font-bold text-white drop-shadow-md tracking-wider">
                        HP <span id="hpText">100</span> / 100
                    </div>
                </div>
                
                <div class="text-xl font-bold text-sky-400 drop-shadow-md">è·é›¢: <span id="scoreDisplay">0</span> m</div>
                <div class="text-xs text-gray-400 bg-slate-900/60 px-2 py-1 rounded inline-block backdrop-blur-sm border border-slate-700">
                    é›£åº¦: <span id="diffDisplay">ç°¡å–®</span>
                </div>
            </div>
            
            <!-- Right: Visualizer & Controls -->
            <div class="flex flex-col items-end gap-2 interactive">
                <!-- Pitch Visualizer -->
                <div class="w-48 h-20 bg-slate-900/80 border border-slate-700 rounded-lg p-1 relative overflow-hidden flex flex-col justify-end shadow-lg">
                    <div class="text-[10px] text-gray-400 absolute top-1 left-2 z-10 uppercase tracking-wider">Pitch Monitor</div>
                    <div id="pitchBar" class="h-full bg-gradient-to-r from-emerald-500 via-yellow-400 to-red-500 w-0 transition-all duration-75 opacity-70 absolute top-0 left-0"></div>
                    <div id="freqDisplay" class="relative z-10 text-right pr-2 text-xs text-white font-mono opacity-80">0 Hz</div>
                    <div id="noteDisplay" class="relative z-10 text-right pr-2 text-xl font-bold text-sky-300 leading-none pb-1">--</div>
                    <!-- Center Marker -->
                    <div class="absolute top-0 left-1/2 w-px h-full bg-white/20 border-l border-dashed border-white/40"></div>
                </div>

                <!-- Buttons Row -->
                <div class="flex gap-2">
                    <button onclick="togglePause()" id="pauseBtn" class="bg-amber-600 hover:bg-amber-500 text-white p-2 rounded text-xs transition-colors shadow-lg font-bold w-20 flex justify-center items-center gap-1">
                        â¸ æš«åœ
                    </button>
                    <button onclick="openSettings()" class="bg-slate-700 hover:bg-slate-600 text-white p-2 rounded text-xs transition-colors shadow-lg flex items-center gap-1">
                        âš™ï¸ è¨­å®š
                    </button>
                </div>
            </div>
        </div>

        <!-- Start Screen -->
        <div id="startScreen" class="absolute inset-0 flex items-center justify-center interactive bg-slate-900/95 z-50 transition-opacity duration-300">
            <div class="panel my-auto flex flex-col h-full justify-center relative">
                <h1 class="text-4xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-sky-400 to-cyan-300 mb-1">
                    è²æ§é£›æ¢­ <br> <span class="text-xl text-sky-200 font-normal">Sonic Odyssey</span>
                </h1>
                <div class="text-sky-500 font-bold mb-3 text-xs tracking-widest uppercase">by å°è¬è€å¸«</div>
                
                <button onclick="toggleTutorial()" class="mb-4 mx-auto bg-slate-800 hover:bg-slate-700 text-sky-300 text-xs py-1.5 px-4 rounded-full border border-slate-600 flex items-center gap-1 transition-colors">
                    ğŸ“– éŠæˆ²èˆ‡é™å™ªæ•™å­¸
                </button>

                <div class="overflow-y-auto pr-2 custom-scrollbar flex-1 text-sm">
                    <!-- Config Sections -->
                    <div class="space-y-3">
                        <!-- 1. Voice -->
                        <div class="bg-slate-800/50 p-3 rounded-xl border border-slate-700/50">
                            <h3 class="font-bold text-sky-200 mb-2 text-xs flex items-center gap-2">ğŸ™ï¸ é¸æ“‡éŸ³åŸŸ</h3>
                            <div class="grid grid-cols-2 gap-2 radio-group">
                                <label class="relative block">
                                    <input type="radio" name="voiceRange" value="male" class="hidden" checked onchange="app.updateConfig()">
                                    <div class="border border-slate-600 rounded-lg p-2 text-center hover:bg-slate-700/50">
                                        <div class="text-lg">ğŸ‘¨ ç”·è²</div>
                                        <div class="text-[10px] text-gray-500">80Hz - 450Hz</div>
                                    </div>
                                </label>
                                <label class="relative block">
                                    <input type="radio" name="voiceRange" value="female" class="hidden" onchange="app.updateConfig()">
                                    <div class="border border-slate-600 rounded-lg p-2 text-center hover:bg-slate-700/50">
                                        <div class="text-lg">ğŸ‘© å¥³è²</div>
                                        <div class="text-[10px] text-gray-500">150Hz - 800Hz</div>
                                    </div>
                                </label>
                            </div>
                        </div>

                        <!-- 2. Difficulty -->
                        <div class="bg-slate-800/50 p-3 rounded-xl border border-slate-700/50">
                            <h3 class="font-bold text-sky-200 mb-2 text-xs">ğŸ® é¸æ“‡é›£åº¦</h3>
                            <div class="grid grid-cols-3 gap-2 radio-group diff-group">
                                <label class="relative block">
                                    <input type="radio" name="difficulty" value="easy" class="hidden" checked onchange="app.updateConfig()">
                                    <div class="border border-slate-600 rounded-lg p-2 text-center hover:bg-slate-700/50">
                                        <div class="font-bold">ç°¡å–®</div>
                                    </div>
                                </label>
                                <label class="relative block">
                                    <input type="radio" name="difficulty" value="medium" class="hidden" onchange="app.updateConfig()">
                                    <div class="border border-slate-600 rounded-lg p-2 text-center hover:bg-slate-700/50">
                                        <div class="font-bold">ä¸­ç­‰</div>
                                    </div>
                                </label>
                                <label class="relative block">
                                    <input type="radio" name="difficulty" value="hard" class="hidden" onchange="app.updateConfig()">
                                    <div class="border border-slate-600 rounded-lg p-2 text-center hover:bg-slate-700/50">
                                        <div class="font-bold">å›°é›£</div>
                                    </div>
                                </label>
                            </div>
                        </div>

                        <!-- 3. Mic Test -->
                        <div class="bg-slate-800/50 p-3 rounded-xl border border-slate-700/50">
                            <h3 class="font-bold text-sky-200 mb-2 text-xs">ğŸ”Š ç™¼è²æ¸¬è©¦èˆ‡èª¿æ ¡</h3>
                            <div class="w-full h-8 bg-slate-900 rounded overflow-hidden border border-slate-700 relative mb-3">
                                <div id="previewPitchBar" class="h-full bg-sky-500 w-0 transition-all duration-75"></div>
                                <div class="absolute inset-0 flex items-center justify-center pointer-events-none gap-2 text-xs">
                                    <span id="previewNote" class="font-bold text-white drop-shadow">--</span>
                                    <span id="previewFreq" class="text-gray-400">æœªåµæ¸¬</span>
                                </div>
                            </div>
                            <!-- Sliders -->
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="text-[10px] text-sky-300 flex justify-between mb-1">
                                        <span>é–¥å€¼(Sensitivity)</span><span class="val-threshold text-white">25</span>
                                    </label>
                                    <input type="range" class="input-threshold" min="1" max="60" value="25" oninput="app.updateSettings(this.value, null, null)">
                                </div>
                                <div>
                                    <label class="text-[10px] text-sky-300 flex justify-between mb-1">
                                        <span>é™å™ª(Filter)</span><span class="val-reduction text-white">0%</span>
                                    </label>
                                    <input type="range" class="input-reduction" min="0" max="100" value="0" oninput="app.updateSettings(null, this.value, null)">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Footer Buttons -->
                <div class="flex gap-3 mt-4">
                     <button onclick="app.initAudio()" class="flex-1 bg-slate-700 hover:bg-slate-600 text-white font-bold py-3 px-2 rounded-lg transition-colors text-sm">
                        1. é–‹å•Ÿéº¥å…‹é¢¨
                    </button>
                    <button onclick="app.startGame()" id="startBtn" class="flex-1 bg-gradient-to-r from-sky-500 to-blue-600 hover:from-sky-400 hover:to-blue-500 text-white font-bold py-3 px-2 rounded-lg shadow-lg transform transition hover:scale-105 disabled:opacity-50 disabled:cursor-not-allowed text-sm" disabled>
                        2. å•Ÿå‹•å¼•æ“
                    </button>
                </div>
                
                <a href="https://sites.google.com/view/cutedavid/%E9%A6%96%E9%A0%81?authuser=0" target="_blank" class="block w-full mt-3 text-sky-500/80 hover:text-sky-400 text-xs py-2 transition-colors">
                    ğŸ”™ è¿”å›è¬è€å¸«å¯¦é©—å®¤
                </a>
            </div>
        </div>

        <!-- Pause Screen (Overlay) -->
        <div id="pauseScreen" class="hidden absolute inset-0 flex items-center justify-center interactive z-40 bg-slate-900/60 backdrop-blur-sm">
            <div class="text-center">
                <h2 class="text-5xl font-bold text-white mb-2 tracking-widest drop-shadow-lg">PAUSED</h2>
                <p class="text-sky-300 text-sm mb-6">æŒ‰ä¸‹ ESC æˆ–é»æ“ŠæŒ‰éˆ•ç¹¼çºŒ</p>
                <button onclick="togglePause()" class="bg-amber-500 hover:bg-amber-400 text-white font-bold py-3 px-8 rounded-full shadow-lg transition transform hover:scale-105">
                    â–¶ ç¹¼çºŒé£›è¡Œ
                </button>
            </div>
        </div>

        <!-- Tutorial Modal -->
        <div id="tutorialModal" class="hidden absolute inset-0 flex items-center justify-center interactive z-[60] bg-black/70 backdrop-blur-md">
            <div class="panel relative text-left">
                <button onclick="toggleTutorial()" class="absolute top-2 right-3 text-gray-400 hover:text-white p-2 text-xl">âœ•</button>
                <h3 class="text-xl font-bold text-white mb-4 border-b border-slate-700 pb-2 text-center">éŠæˆ²èˆ‡èª¿æ ¡æŒ‡å—</h3>
                
                <div class="overflow-y-auto max-h-[60vh] custom-scrollbar pr-2">
                    <div class="tutorial-section mb-6">
                        <h4>ğŸš€ éŠæˆ²æ“ä½œç©æ³•</h4>
                        <p>
                            ä½¿ç”¨<span class="text-sky-400 font-bold">è²éŸ³çš„é«˜ä½</span>ä¾†æ§åˆ¶é£›èˆ¹ã€‚<br>
                            ğŸµ <span class="text-green-400">ç™¼å‡ºé«˜éŸ³</span> â¡ é£›èˆ¹<span class="text-green-400 font-bold">ä¸Šå‡</span><br>
                            ğŸµ <span class="text-red-400">ç™¼å‡ºä½éŸ³</span> â¡ é£›èˆ¹<span class="text-red-400 font-bold">ä¸‹é™</span><br>
                            <span class="text-yellow-400 font-bold">â¤ï¸ ç”Ÿå‘½å€¼</span>ï¼šæ»¿è¡€ 100ï¼Œæ¯æ¬¡ç¢°æ’æ‰£ 20 é»ã€‚æ‰£å®Œæ‰ç®—å¤±æ•—ã€‚æ’æ“Šå¾Œæœ‰çŸ­æš«ç„¡æ•µæ™‚é–“ã€‚
                        </p>
                    </div>

                    <div class="tutorial-section">
                        <h4>ğŸ›ï¸ é™å™ªèˆ‡è¨­å®šæ•™å­¸</h4>
                        <div class="mb-4">
                            <p class="font-bold text-sky-200 mb-1">1. é–¥å€¼ (Sensitivity)</p>
                            <p>è¨­å®š<span class="text-yellow-400">ã€Œå¤šå¤§è²æ‰ç®—æŒ‡ä»¤ã€</span>ã€‚<br>è‹¥æ˜æ˜æ²’èªªè©±é£›èˆ¹å»äº‚å‹•ï¼Œè«‹<span class="text-white font-bold">èª¿é«˜</span>æ•¸å€¼ã€‚</p>
                        </div>
                        <div>
                            <p class="font-bold text-sky-200 mb-1">2. é™å™ª (Noise Filter)</p>
                            <p>è¨­å®š<span class="text-yellow-400">ã€Œéæ¿¾é«˜é »é›œè¨Šã€</span>ã€‚<br>è‹¥ç’°å¢ƒæœ‰é¢¨æ‰‡/é›»æµè²ï¼Œè«‹<span class="text-white font-bold">èª¿é«˜</span>æ­¤æ•¸å€¼ã€‚</p>
                        </div>
                    </div>
                </div>
                <button onclick="toggleTutorial()" class="w-full mt-4 bg-sky-600 hover:bg-sky-500 text-white py-2 rounded font-bold">æˆ‘çŸ¥é“äº†</button>
            </div>
        </div>

        <!-- Settings Modal (In-Game & Start) -->
        <div id="settingsModal" class="hidden absolute inset-0 flex items-center justify-center interactive z-50 bg-black/60 backdrop-blur-md">
            <div class="panel relative">
                <button onclick="closeSettings()" class="absolute top-2 right-3 text-gray-400 hover:text-white p-2 text-xl">âœ•</button>
                <h3 class="text-xl font-bold text-white mb-6 border-b border-slate-700 pb-2">ç³»çµ±èª¿æ ¡</h3>
                
                <div class="space-y-6 text-left">
                    <div>
                        <div class="flex justify-between mb-2">
                            <label class="text-sm text-sky-300 font-bold">è²éŸ³é–¥å€¼ (Sensitivity)</label>
                            <span class="text-xs bg-slate-700 px-2 py-1 rounded text-white val-threshold">25</span>
                        </div>
                        <input type="range" class="input-threshold" min="1" max="60" value="25" oninput="app.updateSettings(this.value, null, null)">
                        <p class="text-xs text-gray-400 mt-1">é˜²æ­¢ç’°å¢ƒå™ªéŸ³èª¤è§¸ç™¼</p>
                    </div>

                    <div>
                        <div class="flex justify-between mb-2">
                            <label class="text-sm text-sky-300 font-bold">èƒŒæ™¯é™å™ª (Filter)</label>
                            <span class="text-xs bg-slate-700 px-2 py-1 rounded text-white val-reduction">0%</span>
                        </div>
                        <input type="range" class="input-reduction" min="0" max="100" value="0" oninput="app.updateSettings(null, this.value, null)">
                        <p class="text-xs text-gray-400 mt-1">éæ¿¾æŒçºŒæ€§é«˜é »å™ªéŸ³</p>
                    </div>

                    <div>
                        <div class="flex justify-between mb-2">
                            <label class="text-sm text-sky-300 font-bold">å¹³æ»‘åº¦ (Smoothing)</label>
                            <span class="text-xs bg-slate-700 px-2 py-1 rounded text-white val-smoothing">0.85</span>
                        </div>
                        <input type="range" class="input-smoothing" min="0" max="0.95" step="0.05" value="0.85" oninput="app.updateSettings(null, null, this.value)">
                        <p class="text-xs text-gray-400 mt-1">æ•¸å€¼è¶Šé«˜ç§»å‹•è¶Šå¹³ç·©</p>
                    </div>
                </div>
                
                <button onclick="closeSettings()" class="w-full bg-sky-600 hover:bg-sky-500 text-white py-2 rounded mt-6">å®Œæˆä¸¦ç¹¼çºŒ</button>
            </div>
        </div>

        <!-- Game Over Screen -->
        <div id="gameOverScreen" class="hidden absolute inset-0 flex items-center justify-center interactive bg-slate-900/90 z-50">
            <div class="panel">
                <div class="text-6xl mb-4">ğŸ’¥</div>
                <h2 class="text-3xl font-bold text-red-500 mb-2">å¢œæ¯€è­¦å ±!</h2>
                <div class="py-4 my-4 bg-slate-800/50 rounded-lg">
                    <p class="text-gray-400 text-sm mb-1">æœ¬æ¬¡é£›è¡Œè·é›¢</p>
                    <p class="text-4xl text-white font-mono"><span id="finalScore" class="text-sky-400">0</span> m</p>
                </div>
                <div class="flex flex-col gap-2">
                    <button onclick="app.returnToTitle()" class="w-full bg-slate-700 hover:bg-slate-600 text-white font-bold py-3 px-6 rounded-lg transition-colors border border-slate-600">
                        è¿”å›é–‹å§‹ç•«é¢
                    </button>
                    <a href="https://sites.google.com/view/cutedavid/%E9%A6%96%E9%A0%81?authuser=0" target="_blank" class="block w-full bg-slate-800 hover:bg-slate-700 text-sky-400 text-sm font-bold py-3 px-4 rounded-lg transition-colors border border-slate-700">
                        ğŸ”™ è¿”å›è¬è€å¸«å¯¦é©—å®¤
                    </a>
                </div>
            </div>
        </div>

    </div>

    <script>
        /**
         * Sonic Odyssey - Game Engine & Logic
         * Consolidated and Optimized
         */
        const app = {
            config: {
                speed: 4,
                gravity: 0.1,
                shipRadius: 14,
                terrainResolution: 40,
                minPitch: 80,
                maxPitch: 450,
                smoothing: 0.85,
                noiseThreshold: 25,
                noiseReduction: 0,
                safeZoneDistance: 600,
                difficulty: 'easy',
                gapSizeFactor: 0.6,
                obstacleChance: 0,
                maxHp: 100,
                damagePerHit: 20,
                invulnerabilityDuration: 1500 // ms
            },
            state: {
                screen: 'start', // start, playing, paused, gameover
                isPaused: false,
                wasPausedBySettings: false,
                score: 0,
                distance: 0,
                lastTime: 0,
                shipY: 0,
                targetY: 0,
                hp: 100,
                invulnerableEndTime: 0,
                terrainPoints: [],
                obstacles: [],
                particles: [],
                terrainNoiseOffset: 0,
                
                // Audio
                audioContext: null,
                analyser: null,
                filterNode: null,
                buf: new Float32Array(2048),
                currentPitch: 0,
                currentVolume: 0,
                isMicReady: false
            },
            
            // Music Theory Constants
            NOTE_NAMES: ["C", "C#", "D", "D#", "E", "F", "F#", "G", "G#", "A", "A#", "B"],
            SOLFEGE_NAMES: ["Do", "Di", "Re", "Ri", "Mi", "Fa", "Fi", "Sol", "Si", "La", "Li", "Ti"],

            // --- Initialization ---
            init: function() {
                this.canvas = document.getElementById('gameCanvas');
                this.ctx = this.canvas.getContext('2d');
                this.resize();
                window.addEventListener('resize', () => this.resize());
                
                // Keyboard Pause
                window.addEventListener('keydown', (e) => {
                    if (e.key === 'Escape' || e.key === 'p' || e.key === 'P') {
                        if (this.state.screen === 'playing' || this.state.screen === 'paused') {
                            togglePause();
                        }
                    }
                });

                // Sync UI with default config
                this.syncUI();
                this.updateHPUI();
            },

            resize: function() {
                this.canvas.width = window.innerWidth;
                this.canvas.height = window.innerHeight;
                if (this.state.screen !== 'playing' && this.state.screen !== 'paused') {
                    this.state.shipY = this.canvas.height / 2;
                    this.state.targetY = this.canvas.height / 2;
                }
            },

            // --- Audio System ---
            initAudio: async function() {
                if (this.state.isMicReady) return;
                try {
                    const AudioContext = window.AudioContext || window.webkitAudioContext;
                    this.state.audioContext = new AudioContext();
                    
                    const stream = await navigator.mediaDevices.getUserMedia({ 
                        audio: { echoCancellation: true, noiseSuppression: true, autoGainControl: false } 
                    });
                    
                    const source = this.state.audioContext.createMediaStreamSource(stream);
                    
                    // Filter Node (Lowpass for noise reduction)
                    this.state.filterNode = this.state.audioContext.createBiquadFilter();
                    this.state.filterNode.type = 'lowpass';
                    this.state.filterNode.frequency.value = 22050; // Open by default
                    
                    this.state.analyser = this.state.audioContext.createAnalyser();
                    this.state.analyser.fftSize = 2048;

                    source.connect(this.state.filterNode);
                    this.state.filterNode.connect(this.state.analyser);
                    
                    this.state.isMicReady = true;
                    this.updateSettings(null, this.config.noiseReduction, null); // Apply initial filter
                    
                    // UI Updates
                    const btn = document.getElementById('startBtn');
                    btn.disabled = false;
                    btn.classList.remove('opacity-50', 'cursor-not-allowed');
                    
                    // Start Preview Loop
                    requestAnimationFrame(() => this.previewLoop());
                    
                    return true;
                } catch (e) {
                    alert("ç„¡æ³•å­˜å–éº¥å…‹é¢¨ï¼Œè«‹æª¢æŸ¥æ¬Šé™è¨­å®šã€‚");
                    console.error(e);
                    return false;
                }
            },

            processAudio: function() {
                if (!this.state.analyser) return -1;
                
                // Ensure context is running (browser policy)
                if (this.state.audioContext.state === 'suspended') {
                    this.state.audioContext.resume();
                }

                this.state.analyser.getFloatTimeDomainData(this.state.buf);
                const ac = this.autoCorrelate(this.state.buf, this.state.audioContext.sampleRate);
                
                if (ac !== -1 && ac > 50 && ac < 1500) {
                    // Smooth pitch
                    this.state.currentPitch = this.state.currentPitch * this.config.smoothing + ac * (1 - this.config.smoothing);
                }
                return this.state.currentPitch;
            },

            autoCorrelate: function(buf, sampleRate) {
                let SIZE = buf.length;
                let rms = 0;
                for (let i = 0; i < SIZE; i++) rms += buf[i] * buf[i];
                rms = Math.sqrt(rms / SIZE);
                this.state.currentVolume = rms;

                const thres = this.config.noiseThreshold / 1000;
                if (rms < thres) return -1;

                let r1 = 0, r2 = SIZE - 1, t = 0.2;
                for (let i = 0; i < SIZE / 2; i++) if (Math.abs(buf[i]) < t) { r1 = i; break; }
                for (let i = 1; i < SIZE / 2; i++) if (Math.abs(buf[SIZE - i]) < t) { r2 = SIZE - i; break; }
                buf = buf.slice(r1, r2);
                SIZE = buf.length;

                let c = new Array(SIZE).fill(0);
                for (let i = 0; i < SIZE; i++) for (let j = 0; j < SIZE - i; j++) c[i] = c[i] + buf[j] * buf[j + i];
                
                let d = 0; while (c[d] > c[d + 1]) d++;
                let maxval = -1, maxpos = -1;
                for (let i = d; i < SIZE; i++) if (c[i] > maxval) { maxval = c[i]; maxpos = i; }
                
                let T0 = maxpos;
                let x1 = c[T0 - 1], x2 = c[T0], x3 = c[T0 + 1];
                let a = (x1 + x3 - 2 * x2) / 2;
                let b = (x3 - x1) / 2;
                if (a) T0 = T0 - b / (2 * a);

                return sampleRate / T0;
            },

            getNoteData: function(freq) {
                if (freq <= 0 || this.state.currentVolume < (this.config.noiseThreshold/1000)) return { note: '--', solfege: '--' };
                const noteNum = 12 * (Math.log(freq / 440) / Math.log(2));
                const midi = Math.round(noteNum) + 69;
                const noteIndex = midi % 12;
                const octave = Math.floor(midi / 12) - 1;
                if (noteIndex < 0) return { note: '?', solfege: '?' };
                return { note: this.NOTE_NAMES[noteIndex] + octave, solfege: this.SOLFEGE_NAMES[noteIndex] };
            },

            // --- Configuration Logic ---
            updateConfig: function() {
                // Voice Range
                const mode = document.querySelector('input[name="voiceRange"]:checked').value;
                if (mode === 'male') { this.config.minPitch = 80; this.config.maxPitch = 450; }
                else { this.config.minPitch = 150; this.config.maxPitch = 800; }

                // Difficulty
                const diff = document.querySelector('input[name="difficulty"]:checked').value;
                this.config.difficulty = diff;
                const diffEl = document.getElementById('diffDisplay');
                
                if (diff === 'easy') {
                    this.config.gapSizeFactor = 0.65; this.config.obstacleChance = 0;
                    diffEl.innerText = "ç°¡å–®"; diffEl.style.color = "#4ade80";
                } else if (diff === 'medium') {
                    this.config.gapSizeFactor = 0.55; this.config.obstacleChance = 0.15;
                    diffEl.innerText = "ä¸­ç­‰"; diffEl.style.color = "#facc15";
                } else {
                    this.config.gapSizeFactor = 0.45; this.config.obstacleChance = 0.30;
                    diffEl.innerText = "å›°é›£"; diffEl.style.color = "#f87171";
                }
            },

            updateSettings: function(thresh, reduct, smooth) {
                if (thresh !== null) this.config.noiseThreshold = parseFloat(thresh);
                if (smooth !== null) this.config.smoothing = parseFloat(smooth);
                if (reduct !== null) {
                    this.config.noiseReduction = parseFloat(reduct);
                    if (this.state.filterNode) {
                        // Linear mapping 0-100 to 22050Hz - 800Hz
                        const freq = 22050 - ((22050 - 800) * (this.config.noiseReduction / 100));
                        this.state.filterNode.frequency.value = freq;
                    }
                }
                this.syncUI();
            },

            syncUI: function() {
                // Sync all inputs with class names across the DOM
                document.querySelectorAll('.input-threshold').forEach(el => el.value = this.config.noiseThreshold);
                document.querySelectorAll('.val-threshold').forEach(el => el.innerText = this.config.noiseThreshold);
                
                document.querySelectorAll('.input-reduction').forEach(el => el.value = this.config.noiseReduction);
                document.querySelectorAll('.val-reduction').forEach(el => el.innerText = this.config.noiseReduction + '%');
                
                document.querySelectorAll('.input-smoothing').forEach(el => el.value = this.config.smoothing);
                document.querySelectorAll('.val-smoothing').forEach(el => el.innerText = this.config.smoothing);
            },
            
            updateHPUI: function() {
                const hpPercent = (this.state.hp / this.config.maxHp) * 100;
                const bar = document.getElementById('hpBar');
                const text = document.getElementById('hpText');
                
                bar.style.width = hpPercent + '%';
                text.innerText = this.state.hp;
                
                // Color change based on HP
                if(hpPercent > 60) bar.className = 'h-full bg-green-500 transition-all duration-300 w-full';
                else if(hpPercent > 30) bar.className = 'h-full bg-yellow-500 transition-all duration-300 w-full';
                else bar.className = 'h-full bg-red-600 transition-all duration-300 w-full';
            },

            // --- Game Loops ---
            previewLoop: function() {
                if (this.state.screen !== 'start') return;
                this.processAudio();
                
                const percent = Math.max(0, Math.min(1, (this.state.currentPitch - this.config.minPitch) / (this.config.maxPitch - this.config.minPitch)));
                const bar = document.getElementById('previewPitchBar');
                const noteEl = document.getElementById('previewNote');
                const freqEl = document.getElementById('previewFreq');

                bar.style.width = (percent * 100) + '%';
                
                // Show info only if volume is enough
                if (this.state.currentVolume > this.config.noiseThreshold / 1000) {
                    const data = this.getNoteData(this.state.currentPitch);
                    freqEl.innerText = Math.round(this.state.currentPitch) + " Hz";
                    noteEl.innerText = `${data.note} (${data.solfege})`;
                    bar.style.opacity = 1;
                } else {
                    freqEl.innerText = "ç­‰å¾…è²éŸ³...";
                    noteEl.innerText = "--";
                    bar.style.opacity = 0.3;
                }
                
                requestAnimationFrame(() => this.previewLoop());
            },

            startGame: function() {
                if (!this.state.isMicReady) { this.initAudio().then(ok => { if(ok) this.startGame(); }); return; }
                
                this.updateConfig();
                document.getElementById('startScreen').classList.add('opacity-0', 'pointer-events-none');
                document.getElementById('hud').classList.remove('opacity-0');
                
                this.resetGameState();
                this.state.screen = 'playing';
                this.state.lastTime = performance.now();
                requestAnimationFrame((t) => this.gameLoop(t));
            },

            gameLoop: function(timestamp) {
                if (this.state.screen !== 'playing') return;
                
                // Logic
                if (!this.state.isPaused) {
                    this.updatePhysics();
                    this.updateWorld();
                }

                // Render (Always render, even if paused, to keep last frame or overlay)
                this.draw();

                if (this.state.isPaused) {
                    // Draw pause overlay logic is handled by CSS mostly, but loop stops here
                    return; 
                }

                requestAnimationFrame((t) => this.gameLoop(t));
            },

            updatePhysics: function() {
                this.processAudio();
                const percent = Math.max(0, Math.min(1, (this.state.currentPitch - this.config.minPitch) / (this.config.maxPitch - this.config.minPitch)));
                
                // Update HUD
                document.getElementById('pitchBar').style.width = (percent * 100) + '%';
                document.getElementById('freqDisplay').innerText = Math.round(this.state.currentPitch) + ' Hz';
                const noteData = this.getNoteData(this.state.currentPitch);
                document.getElementById('noteDisplay').innerText = `${noteData.note} ${noteData.solfege}`;

                // Ship Movement
                const padding = this.canvas.height * 0.1;
                const usableHeight = this.canvas.height * 0.8;
                this.state.targetY = (this.canvas.height - padding) - (percent * usableHeight);
                this.state.shipY += (this.state.targetY - this.state.shipY) * 0.1; // Lerp
            },

            updateWorld: function() {
                // Move Terrain & Obstacles
                this.generateTerrain();
                this.state.terrainPoints.forEach(p => p.x -= this.config.speed);
                
                // Cleanup Terrain
                if (this.state.terrainPoints.length > 0 && this.state.terrainPoints[0].x < -this.config.terrainResolution) {
                    this.state.terrainPoints.shift();
                }

                // Obstacles
                for (let i = this.state.obstacles.length - 1; i >= 0; i--) {
                    let obs = this.state.obstacles[i];
                    obs.x -= this.config.speed;
                    obs.rotation += obs.rotSpeed;
                    if (obs.x < -100) this.state.obstacles.splice(i, 1);
                }

                // Particles
                if (Math.random() > 0.2) this.createParticle(this.canvas.width * 0.2 - 20, this.state.shipY, true);
                this.updateParticles();

                // Score
                this.state.distance += this.config.speed;
                this.state.score = Math.floor(this.state.distance / 10);
                document.getElementById('scoreDisplay').innerText = this.state.score;

                // Collision
                if (this.checkCollision()) {
                    // If checkCollision returns true, it means we hit something AND we are not currently invulnerable
                    this.takeDamage();
                }
            },

            takeDamage: function() {
                // Deduct HP
                this.state.hp -= this.config.damagePerHit;
                if(this.state.hp < 0) this.state.hp = 0;
                
                // Update UI
                this.updateHPUI();
                
                // Visual Flash
                const flashOverlay = document.getElementById('damageOverlay');
                flashOverlay.classList.remove('damage-flash');
                void flashOverlay.offsetWidth; // trigger reflow
                flashOverlay.classList.add('damage-flash');
                
                // Explosion particles
                for(let i=0; i<10; i++) {
                     this.createParticle(this.canvas.width * 0.2, this.state.shipY, false);
                }

                // Check Death
                if (this.state.hp <= 0) {
                    this.gameOver();
                } else {
                    // Set Invulnerability
                    this.state.invulnerableEndTime = performance.now() + this.config.invulnerabilityDuration;
                }
            },

            generateTerrain: function() {
                const pointsNeeded = Math.ceil(this.canvas.width / this.config.terrainResolution) + 2;
                
                // Initialize if empty
                if (this.state.terrainPoints.length === 0) {
                    for (let i = 0; i < pointsNeeded; i++) this.addTerrainPoint(i * this.config.terrainResolution);
                }
                
                // Add new point at end
                const lastPoint = this.state.terrainPoints[this.state.terrainPoints.length - 1];
                if (lastPoint.x < this.canvas.width + this.config.terrainResolution) {
                    this.addTerrainPoint(lastPoint.x + this.config.terrainResolution);
                }
            },

            addTerrainPoint: function(x) {
                const isSafe = (this.state.distance + x) < this.config.safeZoneDistance;
                let topY, bottomY;

                if (isSafe) {
                    const gap = this.canvas.height * 0.7;
                    const center = this.canvas.height / 2;
                    topY = center - gap/2;
                    bottomY = center + gap/2;
                    this.state.terrainNoiseOffset += 0.1;
                } else {
                    this.state.terrainNoiseOffset += 0.15;
                    const progress = Math.min(this.state.score / 5000, 1);
                    
                    let gapFactor = this.config.gapSizeFactor - (progress * 0.15);
                    gapFactor = Math.max(0.25, gapFactor);
                    
                    const gap = this.canvas.height * gapFactor;
                    const devAmt = (this.canvas.height * 0.4) * Math.min(1, 0.2 + progress);
                    const deviation = Math.sin(this.state.terrainNoiseOffset) * devAmt;
                    const center = (this.canvas.height / 2) + deviation;

                    topY = center - gap/2;
                    bottomY = center + gap/2;

                    // Spawn Obstacle
                    if (Math.random() < this.config.obstacleChance) this.addObstacle(x, topY, bottomY);
                }

                topY = Math.max(10, topY);
                bottomY = Math.min(this.canvas.height - 10, bottomY);
                this.state.terrainPoints.push({ x, topY, bottomY });
            },

            addObstacle: function(x, top, bottom) {
                const h = bottom - top;
                const pad = 40;
                if (h < pad * 2) return;
                
                this.state.obstacles.push({
                    x: x,
                    y: top + pad + Math.random() * (h - pad*2),
                    radius: 15 + Math.random() * 20,
                    rotation: Math.random() * Math.PI * 2,
                    rotSpeed: (Math.random() - 0.5) * 0.1
                });
            },

            createParticle: function(x, y, isEngine) {
                const hue = isEngine ? (Math.random() * 40 + 10) : (Math.random() * 60 + 180); // Orange/Red vs Blue/Explosion
                this.state.particles.push({
                    x, y,
                    vx: isEngine ? (-this.config.speed - Math.random() * 3) : ((Math.random()-0.5) * 10),
                    vy: isEngine ? ((Math.random() - 0.5) * 3) : ((Math.random()-0.5) * 10),
                    life: 1.0,
                    color: `hsl(${isEngine ? hue : 0}, 100%, ${isEngine ? '60%' : '50%'})`,
                    size: Math.random() * 3 + 1
                });
            },

            updateParticles: function() {
                for (let i = this.state.particles.length - 1; i >= 0; i--) {
                    let p = this.state.particles[i];
                    p.x += p.vx; p.y += p.vy; p.life -= 0.04;
                    if (p.life <= 0) this.state.particles.splice(i, 1);
                }
            },

            checkCollision: function() {
                // If currently invulnerable, no collision detection
                if (performance.now() < this.state.invulnerableEndTime) return false;

                const shipX = this.canvas.width * 0.2;
                const r = this.config.shipRadius * 0.7;
                const y = this.state.shipY;

                // Terrain
                for (let i = 0; i < this.state.terrainPoints.length - 1; i++) {
                    const p1 = this.state.terrainPoints[i];
                    const p2 = this.state.terrainPoints[i+1];
                    if (p1.x <= shipX + r && p2.x >= shipX - r) {
                        const t = (shipX - p1.x) / (p2.x - p1.x);
                        const roof = p1.topY + (p2.topY - p1.topY) * t;
                        const floor = p1.bottomY + (p2.bottomY - p1.bottomY) * t;
                        if (y - r < roof || y + r > floor) return true;
                    }
                }

                // Obstacles
                for (let obs of this.state.obstacles) {
                    if (Math.abs(obs.x - shipX) < 100) { // Optimization check
                        const dist = Math.sqrt(Math.pow(shipX - obs.x, 2) + Math.pow(y - obs.y, 2));
                        if (dist < (r + obs.radius * 0.8)) return true;
                    }
                }
                return false;
            },

            // --- Rendering ---
            draw: function() {
                const w = this.canvas.width, h = this.canvas.height;
                this.ctx.clearRect(0, 0, w, h);
                
                // BG
                this.ctx.fillStyle = '#0f172a';
                this.ctx.fillRect(0, 0, w, h);

                // Grid
                this.ctx.strokeStyle = 'rgba(56, 189, 248, 0.08)';
                this.ctx.lineWidth = 1;
                const offset = this.state.distance % 60;
                for(let x = -offset; x < w; x+=60) { this.ctx.beginPath(); this.ctx.moveTo(x,0); this.ctx.lineTo(x,h); this.ctx.stroke(); }
                for(let y = 0; y < h; y+=60) { this.ctx.beginPath(); this.ctx.moveTo(0,y); this.ctx.lineTo(w,y); this.ctx.stroke(); }

                // Safe Zone
                if (this.state.distance < this.config.safeZoneDistance) {
                    this.ctx.fillStyle = 'rgba(16, 185, 129, 0.05)'; this.ctx.fillRect(0,0,w,h);
                    this.ctx.fillStyle = 'rgba(16, 185, 129, 0.5)'; this.ctx.font = '20px sans-serif'; this.ctx.textAlign = 'center';
                    this.ctx.fillText("å®‰å…¨èµ·é£›å€ (Safe Zone)", w/2, h/2 + 100);
                }

                // Obstacles
                this.state.obstacles.forEach(obs => {
                    this.ctx.save();
                    this.ctx.translate(obs.x, obs.y);
                    this.ctx.rotate(obs.rotation);
                    this.ctx.fillStyle = '#94a3b8';
                    this.ctx.beginPath();
                    for(let i=0; i<14; i++){
                        const r = (i%2===0) ? obs.radius : obs.radius/1.5;
                        const a = (Math.PI*i)/7;
                        this.ctx.lineTo(Math.cos(a)*r, Math.sin(a)*r);
                    }
                    this.ctx.fill();
                    this.ctx.fillStyle = '#ef4444'; 
                    this.ctx.beginPath(); this.ctx.arc(0,0,obs.radius*0.3,0,Math.PI*2); this.ctx.fill();
                    this.ctx.restore();
                });

                // Terrain
                this.ctx.lineWidth = 4;
                if(this.state.terrainPoints.length > 0) {
                    this.ctx.fillStyle = '#1e293b'; this.ctx.strokeStyle = '#ef4444';
                    this.ctx.beginPath(); this.ctx.moveTo(this.state.terrainPoints[0].x, 0);
                    this.state.terrainPoints.forEach(p => this.ctx.lineTo(p.x, p.topY));
                    this.ctx.lineTo(this.state.terrainPoints[this.state.terrainPoints.length-1].x, 0);
                    this.ctx.fill(); this.ctx.stroke();

                    this.ctx.strokeStyle = '#22c55e';
                    this.ctx.beginPath(); this.ctx.moveTo(this.state.terrainPoints[0].x, h);
                    this.state.terrainPoints.forEach(p => this.ctx.lineTo(p.x, p.bottomY));
                    this.ctx.lineTo(this.state.terrainPoints[this.state.terrainPoints.length-1].x, h);
                    this.ctx.fill(); this.ctx.stroke();
                }

                // Ship
                const shipX = w * 0.2;
                this.ctx.save();
                this.ctx.translate(shipX, this.state.shipY);
                
                // Invulnerability Blinking
                let isInvulnerable = performance.now() < this.state.invulnerableEndTime;
                if (isInvulnerable) {
                    // Flash effect (50ms interval)
                    if (Math.floor(performance.now() / 50) % 2 === 0) {
                        this.ctx.globalAlpha = 0.3;
                    }
                }

                const tilt = (this.state.targetY - this.state.shipY) * 0.05;
                this.ctx.rotate(Math.min(Math.max(tilt, -0.6), 0.6));
                
                // Draw Ship
                this.ctx.fillStyle = isInvulnerable ? '#ffaaaa' : '#facc15';
                this.ctx.beginPath(); this.ctx.moveTo(18,0); this.ctx.lineTo(-12,12); this.ctx.lineTo(-12,-12); this.ctx.fill();
                this.ctx.fillStyle = '#0ea5e9';
                this.ctx.beginPath(); this.ctx.arc(-2,0,6,0,Math.PI*2); this.ctx.fill();
                
                if(!isInvulnerable) {
                    this.ctx.shadowBlur = 20; this.ctx.shadowColor = '#f59e0b';
                }
                
                this.ctx.restore();
                this.ctx.globalAlpha = 1.0;

                // Particles
                this.state.particles.forEach(p => {
                    this.ctx.fillStyle = p.color; this.ctx.globalAlpha = p.life;
                    this.ctx.beginPath(); this.ctx.arc(p.x, p.y, p.size, 0, Math.PI*2); this.ctx.fill();
                });
                this.ctx.globalAlpha = 1.0;
            },

            // --- State Management ---
            resetGameState: function() {
                this.resize();
                this.state.score = 0;
                this.state.distance = 0;
                this.state.hp = this.config.maxHp;
                this.state.invulnerableEndTime = 0;
                this.state.terrainPoints = [];
                this.state.obstacles = [];
                this.state.particles = [];
                this.state.terrainNoiseOffset = 0;
                this.updateHPUI();
                this.generateTerrain();
            },

            gameOver: function() {
                this.state.screen = 'gameover';
                document.getElementById('gameOverScreen').classList.remove('hidden');
                document.getElementById('hud').classList.add('opacity-0');
                document.getElementById('finalScore').innerText = this.state.score;
            },

            returnToTitle: function() {
                this.state.screen = 'start';
                document.getElementById('gameOverScreen').classList.add('hidden');
                document.getElementById('startScreen').classList.remove('opacity-0', 'pointer-events-none');
                requestAnimationFrame(() => this.previewLoop());
            }
        };

        // Global functions for HTML interaction
        function togglePause() {
            if (app.state.screen !== 'playing' && app.state.screen !== 'paused') return;
            
            app.state.isPaused = !app.state.isPaused;
            
            const pauseScreen = document.getElementById('pauseScreen');
            const btn = document.getElementById('pauseBtn');
            
            if (app.state.isPaused) {
                app.state.screen = 'paused';
                pauseScreen.classList.remove('hidden');
                btn.innerText = "â–¶ ç¹¼çºŒ";
                btn.classList.replace('bg-amber-600', 'bg-green-600');
            } else {
                app.state.screen = 'playing';
                pauseScreen.classList.add('hidden');
                btn.innerText = "â¸ æš«åœ";
                btn.classList.replace('bg-green-600', 'bg-amber-600');
                // Resume loop
                requestAnimationFrame((t) => app.gameLoop(t));
            }
        }

        function openSettings() {
            document.getElementById('settingsModal').classList.remove('hidden');
            if (app.state.screen === 'playing') {
                app.state.wasPausedBySettings = true;
                if (!app.state.isPaused) togglePause();
            }
        }

        function closeSettings() {
            document.getElementById('settingsModal').classList.add('hidden');
            if (app.state.wasPausedBySettings) {
                app.state.wasPausedBySettings = false;
                if (app.state.isPaused) togglePause();
            }
        }

        function toggleTutorial() {
            document.getElementById('tutorialModal').classList.toggle('hidden');
        }

        // Boot
        window.onload = () => app.init();
    </script>
</body>
</html>
