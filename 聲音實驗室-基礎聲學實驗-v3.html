<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>è²éŸ³å¯¦é©—å®¤ v2.6.1 (Graph Fix)</title>
    <!-- Tailwind CSS (Keep in HTML) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
    
    <style>
        /* ========================================= */
        /* COPY TO: style.css              */
        /* ========================================= */

        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;700&family=Roboto+Mono:wght@400;700&display=swap');

        :root {
            --sidebar-width: 280px;
            --header-height: 64px;
        }

        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: #0f172a; /* Slate 900 */
            color: #e2e8f0; /* Slate 200 */
            overscroll-behavior: none; /* Prevent pull-to-refresh on mobile */
        }

        .mono-font { font-family: 'Roboto Mono', monospace; }

        /* --- UI Components --- */
        
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #1e293b; }
        ::-webkit-scrollbar-thumb { background: #475569; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #64748b; }

        /* Range Slider */
        input[type=range] {
            -webkit-appearance: none; width: 100%; background: transparent;
            height: 24px; cursor: pointer;
        }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none; height: 20px; width: 20px;
            border-radius: 50%; background: #10b981; margin-top: -8px;
            box-shadow: 0 0 10px rgba(16, 185, 129, 0.4);
        }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%; height: 4px; background: #334155; border-radius: 2px;
        }
        input.temp-slider::-webkit-slider-thumb { background: #f59e0b; box-shadow: 0 0 10px rgba(245, 158, 11, 0.4); }
        input.metro-slider::-webkit-slider-thumb { background: #8b5cf6; box-shadow: 0 0 10px rgba(139, 92, 246, 0.4); }
        input.doppler-slider::-webkit-slider-thumb { background: #ec4899; box-shadow: 0 0 10px rgba(236, 72, 153, 0.4); }
        input.ultra-slider::-webkit-slider-thumb { background: #06b6d4; box-shadow: 0 0 10px rgba(6, 182, 212, 0.4); }
        input.sonic-slider::-webkit-slider-thumb { background: #f43f5e; box-shadow: 0 0 10px rgba(244, 63, 94, 0.4); } 
        input.res-slider::-webkit-slider-thumb { background: #eab308; box-shadow: 0 0 10px rgba(234, 179, 8, 0.4); } /* Yellow */

        /* Oscilloscope Screen */
        .oscilloscope-screen {
            background-color: #020617;
            background-image: linear-gradient(rgba(16, 185, 129, 0.1) 1px, transparent 1px), linear-gradient(90deg, rgba(16, 185, 129, 0.1) 1px, transparent 1px);
            background-size: 20px 20px; background-position: center;
            border: 1px solid #334155; border-radius: 0.5rem;
            position: relative; overflow: hidden;
        }
        .oscilloscope-screen.grid-on::after { content: ''; position: absolute; top: 50%; left: 0; right: 0; height: 1px; background: rgba(0, 255, 0, 0.4); pointer-events: none; }
        .oscilloscope-screen.grid-on::before { content: ''; position: absolute; left: 50%; top: 0; bottom: 0; width: 1px; background: rgba(0, 255, 0, 0.4); pointer-events: none; }

        /* DB Meter */
        .db-meter-container {
            background-color: #1e293b; border: 1px solid #334155; border-radius: 0.5rem;
            height: 36px; overflow: hidden; position: relative;
        }
        .db-bar {
            height: 100%; width: 0%;
            background: linear-gradient(90deg, #10b981 60%, #f59e0b 80%, #ef4444 100%);
            transition: width 0.08s ease-out;
        }

        /* Sidebar */
        .sidebar {
            width: var(--sidebar-width); height: calc(100vh - var(--header-height));
            position: fixed; top: var(--header-height); left: 0;
            background-color: #1e293b; border-right: 1px solid #334155;
            transform: translateX(0); transition: transform 0.3s ease-in-out;
            z-index: 40; display: flex; flex-direction: column;
        }
        @media (max-width: 768px) {
            .sidebar { transform: translateX(-100%); width: 100%; }
            .sidebar.open { transform: translateX(0); }
        }
        .nav-btn {
            border-left: 4px solid transparent; transition: all 0.2s;
            text-align: left; padding: 1rem 1.5rem; width: 100%;
            color: #94a3b8; font-weight: 500;
        }
        .nav-btn:hover { background-color: #334155; color: #f8fafc; }
        .nav-btn.active { background-color: #0f172a; border-left-color: #10b981; color: #10b981; }
        .nav-btn-icon { margin-right: 0.75rem; font-size: 1.2rem; }

        /* Modals */
        .modal-backdrop {
            position: fixed; inset: 0; background: rgba(0, 0, 0, 0.7);
            z-index: 60; opacity: 0; pointer-events: none; transition: opacity 0.2s;
            display: flex; align-items: center; justify-content: center; backdrop-filter: blur(2px);
        }
        .modal-backdrop.open { opacity: 1; pointer-events: auto; }
        .modal-content {
            background: #1e293b; max-width: 600px; width: 90%; max-height: 85vh;
            border-radius: 0.75rem; border: 1px solid #475569;
            transform: scale(0.95); transition: transform 0.2s;
            display: flex; flex-direction: column;
        }
        .modal-backdrop.open .modal-content { transform: scale(1); }

        .btn-select {
            flex: 1; padding: 0.75rem; background: #334155; color: #94a3b8;
            border-radius: 0.5rem; transition: all 0.2s; border: 1px solid transparent;
        }
        .btn-select.active { background: #0f172a; color: #10b981; border-color: #10b981; font-weight: bold; }
        
        .formula-box {
            background: #0f172a; padding: 0.75rem; border-radius: 0.5rem;
            font-family: 'Roboto Mono', monospace; font-size: 0.9rem; color: #cbd5e1;
            border-left: 3px solid #3b82f6; margin: 0.5rem 0;
        }

        .beat-indicator {
            width: 140px; height: 140px; border-radius: 50%;
            background: #1e293b; border: 4px solid #334155;
            display: flex; align-items: center; justify-content: center;
            font-size: 4rem; font-weight: bold; color: #475569;
            font-family: 'Roboto Mono', monospace; transition: all 0.05s;
        }
        .beat-indicator.active-weak { background: #8b5cf6; border-color: #c4b5fd; color: white; box-shadow: 0 0 20px rgba(139, 92, 246, 0.4); transform: scale(1.05); }
        .beat-indicator.active-strong { background: #ef4444; border-color: #fca5a5; color: white; box-shadow: 0 0 40px rgba(239, 68, 68, 0.6); transform: scale(1.15); }
        
        /* ========================================= */
        /* END OF style.css                */
        /* ========================================= */
    </style>
</head>
<body class="h-screen flex flex-col">

    <!-- HEADER -->
    <header class="h-[64px] bg-slate-900 border-b border-slate-700 flex items-center justify-between px-4 z-50 flex-shrink-0">
        <div class="flex items-center gap-4">
            <button id="btn-menu" class="md:hidden text-slate-300 hover:text-white p-2">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" /></svg>
            </button>
            <div class="flex flex-col justify-center">
                <div class="flex items-baseline gap-2">
                    <h1 class="text-lg md:text-2xl font-bold text-emerald-400 tracking-tight">ç·šä¸Šè²éŸ³å¯¦é©—</h1>
                    <span class="text-xs text-slate-500 font-mono bg-slate-800 px-1.5 py-0.5 rounded">v2.6.1</span>
                </div>
                <span class="text-[10px] text-slate-400 font-bold tracking-wider">åŸºç¤è²å­¸å¯¦é©—å®¤</span>
            </div>
        </div>
        <a href="https://sites.google.com/view/cutedavid/%E9%A6%96%E9%A0%81" target="_blank" class="hidden md:flex items-center text-xs text-slate-400 hover:text-white transition">
            <span class="mr-1">â†</span> è¿”å›æ•™å­¸é¦–é 
        </a>
    </header>

    <div class="flex flex-1 overflow-hidden relative">
        
        <!-- SIDEBAR -->
        <aside id="sidebar" class="sidebar">
            <div class="p-4 text-xs text-slate-500 font-bold uppercase tracking-wider mb-2 px-6">åŠŸèƒ½é¸å–®</div>
            <nav class="flex-1 overflow-y-auto">
                <button onclick="switchMode('lab')" id="nav-lab" class="nav-btn active"><span class="nav-btn-icon">âˆ¿</span> æ³¢å½¢è§€å¯Ÿå¯¦é©—å®¤</button>
                <button onclick="switchMode('megaphone')" id="nav-megaphone" class="nav-btn"><span class="nav-btn-icon">ğŸ“¢</span> å¤§è²å…¬æŒ‘æˆ° (åˆ†è²è¨ˆ)</button>
                <button onclick="switchMode('speed')" id="nav-speed" class="nav-btn"><span class="nav-btn-icon">ğŸ’¨</span> è²é€Ÿèˆ‡ä»‹è³ªæ¨¡æ“¬</button>
                <button onclick="switchMode('doppler')" id="nav-doppler" class="nav-btn"><span class="nav-btn-icon">ğŸš‘</span> éƒ½åœå‹’æ•ˆæ‡‰æ¨¡æ“¬</button>
                <button onclick="switchMode('sonicboom')" id="nav-sonicboom" class="nav-btn"><span class="nav-btn-icon">ğŸš€</span> éŸ³çˆ†æ¨¡æ“¬ (Sonic Boom)</button>
                <button onclick="switchMode('resonance')" id="nav-resonance" class="nav-btn"><span class="nav-btn-icon">ğŸ·</span> å…±æŒ¯å¯¦é©— (Resonance)</button>
                <button onclick="switchMode('ultrasound')" id="nav-ultrasound" class="nav-btn"><span class="nav-btn-icon">ğŸ“¡</span> è¶…éŸ³æ³¢å›è²å®šä½</button>
                <button onclick="switchMode('metronome')" id="nav-metronome" class="nav-btn"><span class="nav-btn-icon">â±ï¸</span> ç¯€æ‹å¤§å¸« (Metronome)</button>
            </nav>
            <div class="p-4 border-t border-slate-700 bg-slate-800/50">
                <button onclick="openVersionHistory()" class="flex items-center text-xs text-slate-400 hover:text-white transition w-full p-2 rounded hover:bg-slate-700"><span class="mr-2">ğŸ•’</span> ç‰ˆæœ¬ç´€éŒ„ (Changelog)</button>
                <div class="mt-3 text-[10px] text-slate-600 flex justify-end"><span>Build 2024.12</span></div>
            </div>
        </aside>

        <div id="sidebar-overlay" class="fixed inset-0 bg-black/50 z-30 hidden md:hidden glass"></div>

        <!-- MAIN CONTENT -->
        <main class="flex-1 bg-slate-900 overflow-y-auto w-full md:pl-[280px] transition-all duration-300">
            
            <!-- Visualizer -->
            <div class="p-4 md:p-6 bg-slate-800 border-b border-slate-700 shadow-lg relative z-10">
                <div class="flex justify-between items-center mb-4">
                    <h2 id="section-title" class="text-lg font-bold text-white flex items-center gap-2"><span class="w-2 h-6 bg-emerald-500 rounded-full inline-block"></span>æ³¢å½¢è§€å¯Ÿå¯¦é©—</h2>
                    <button onclick="openCurrentHelp()" class="text-xs bg-slate-700 hover:bg-slate-600 text-slate-200 px-3 py-1.5 rounded border border-slate-600 transition flex items-center gap-1">â„¹ï¸ èªªæ˜</button>
                </div>

                <div class="w-full h-56 md:h-80 relative">
                    <!-- Lab View -->
                    <div id="view-lab" class="w-full h-full">
                        <div id="oscilloscope-container" class="oscilloscope-screen grid-on w-full h-full group">
                            <canvas id="oscilloscope" class="w-full h-full block opacity-90"></canvas>
                            <div class="absolute top-3 right-4 text-right pointer-events-none z-20">
                                <div class="text-[10px] text-emerald-600 uppercase tracking-widest font-bold">Frequency</div>
                                <div id="display-freq" class="text-3xl md:text-4xl font-bold text-emerald-400 mono-font drop-shadow-md">0 Hz</div>
                            </div>
                            <div class="absolute bottom-3 left-4 pointer-events-none flex gap-6 z-20">
                                <div><div class="text-[10px] text-emerald-600 uppercase tracking-widest font-bold">éŸ³å Note</div><div id="display-note" class="text-xl md:text-2xl font-bold text-slate-100 mono-font drop-shadow-md">--</div></div>
                                <div><div class="text-[10px] text-emerald-600 uppercase tracking-widest font-bold">å”±å SolfÃ¨ge</div><div id="display-solfege" class="text-xl md:text-2xl font-bold text-yellow-400 mono-font drop-shadow-md">--</div></div>
                            </div>
                        </div>
                    </div>

                    <!-- Mega View -->
                    <div id="view-megaphone" class="hidden w-full h-full flex flex-col justify-center items-center bg-slate-900 rounded-lg border border-slate-700 p-4">
                        <div class="text-center w-full max-w-md">
                            <div class="grid grid-cols-2 gap-4 mb-6">
                                <div class="bg-slate-800 p-3 rounded border border-slate-700">
                                    <div class="text-[10px] text-slate-400 uppercase tracking-wider mb-1">å³æ™‚éŸ³é‡</div>
                                    <div id="db-current" class="text-2xl md:text-3xl font-bold text-white mono-font">0 dB</div>
                                </div>
                                <div class="bg-slate-800 p-3 rounded border border-slate-700 relative overflow-hidden">
                                    <div class="text-[10px] text-slate-400 uppercase tracking-wider mb-1">æœ€é«˜ç´€éŒ„</div>
                                    <div id="db-max" class="text-2xl md:text-3xl font-bold text-red-400 mono-font">0 dB</div>
                                    <div class="absolute top-1 right-1 text-lg opacity-30">ğŸ†</div>
                                </div>
                            </div>
                            <div class="db-meter-container w-full mb-1"><div id="db-bar-fill" class="db-bar"></div><div class="absolute top-0 left-[60%] h-full w-px bg-slate-500/30"></div></div>
                            <div class="flex justify-between text-[10px] text-slate-500 mono-font px-1"><span>0</span><span>20</span><span>40</span><span>60</span><span>80</span><span>100 dB</span></div>
                        </div>
                        <button onclick="resetMaxDb()" class="mt-6 text-xs text-slate-400 hover:text-white border border-slate-600 px-3 py-1 rounded transition">â†º é‡ç½®ç´€éŒ„</button>
                    </div>

                    <!-- Speed View -->
                    <div id="view-speed" class="hidden w-full h-full relative bg-slate-900 rounded-lg border border-slate-700 overflow-hidden">
                        <canvas id="speed-canvas" class="w-full h-full block"></canvas>
                        <div class="absolute top-4 left-4 bg-black/40 p-3 rounded backdrop-blur-sm border border-white/10 pointer-events-none">
                            <div class="text-[10px] text-slate-400 uppercase">ç•¶å‰ç’°å¢ƒè²é€Ÿ</div>
                            <div id="speed-val" class="text-3xl font-bold text-amber-400 mono-font">343 m/s</div>
                            <div id="speed-medium-label" class="text-xs text-slate-300 mt-1">ä»‹è³ª: ç©ºæ°£ (20Â°C)</div>
                        </div>
                        <div id="pulse-wave" class="absolute top-0 bottom-0 w-1 bg-white/50 shadow-[0_0_20px_rgba(255,255,255,0.8)] hidden"></div>
                    </div>

                    <!-- Doppler View -->
                    <div id="view-doppler" class="hidden w-full h-full relative bg-slate-900 rounded-lg border border-slate-700 overflow-hidden">
                        <canvas id="doppler-canvas" class="w-full h-full block"></canvas>
                        <div class="absolute top-4 right-4 flex flex-col gap-2 pointer-events-none">
                            <div class="bg-black/50 p-3 rounded border border-white/10 backdrop-blur-sm">
                                <div class="text-[10px] text-pink-400 uppercase font-bold">SOURCE FREQ (ç™¼è²)</div>
                                <div class="text-2xl font-bold text-white mono-font"><span id="dop-src-freq">440</span> Hz</div>
                            </div>
                            <div class="bg-black/50 p-3 rounded border border-white/10 backdrop-blur-sm">
                                <div class="text-[10px] text-emerald-400 uppercase font-bold">OBSERVED FREQ (æ¥æ”¶)</div>
                                <div class="text-2xl font-bold text-white mono-font"><span id="dop-obs-freq">--</span> Hz</div>
                            </div>
                        </div>
                    </div>

                    <!-- Sonic Boom View -->
                    <div id="view-sonicboom" class="hidden w-full h-full relative bg-slate-900 rounded-lg border border-slate-700 overflow-hidden">
                        <canvas id="sonicboom-canvas" class="w-full h-full block"></canvas>
                        <div class="absolute top-4 right-4 flex flex-col gap-2 pointer-events-none">
                            <div class="bg-black/50 p-3 rounded border border-white/10 backdrop-blur-sm text-right">
                                <div class="text-[10px] text-rose-400 uppercase font-bold">MACH NUMBER</div>
                                <div class="text-2xl font-bold text-white mono-font"><span id="sb-mach-display">0.0</span> M</div>
                                <div class="text-xs text-slate-400 mono-font border-t border-white/10 mt-1 pt-1"><span id="sb-view-kmh">0</span> km/h</div>
                            </div>
                        </div>
                    </div>

                    <!-- Resonance View (New v2.6) -->
                    <div id="view-resonance" class="hidden w-full h-full relative bg-slate-900 rounded-lg border border-slate-700 overflow-hidden flex">
                        <div class="flex-1 relative border-r border-slate-700 bg-[#0f172a]">
                            <canvas id="resonance-canvas" class="w-full h-full block"></canvas>
                            <div class="absolute top-4 left-4 bg-black/50 p-2 rounded text-xs text-yellow-400 border border-yellow-900 pointer-events-none">
                                æŒ¯ç›ªç³»çµ± (å—è¿«æŒ¯å‹•)
                            </div>
                        </div>
                        <div class="w-1/3 relative bg-[#020617]">
                             <canvas id="resonance-graph" class="w-full h-full block"></canvas>
                             <div class="absolute top-4 left-4 bg-black/50 p-2 rounded text-xs text-emerald-400 border border-emerald-900 pointer-events-none">
                                æŒ¯å¹…éŸ¿æ‡‰æ›²ç·š
                            </div>
                        </div>
                        <div id="res-warning" class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 text-red-500 font-bold text-4xl border-4 border-red-500 p-4 rounded-xl bg-black/80 hidden animate-pulse pointer-events-none">
                            âš ï¸ å…±æŒ¯ç ´å£!
                        </div>
                    </div>
                    
                    <!-- Ultrasound View -->
                    <div id="view-ultrasound" class="hidden w-full h-full relative bg-slate-900 rounded-lg border border-slate-700 overflow-hidden">
                        <canvas id="ultrasound-canvas" class="w-full h-full block"></canvas>
                        
                        <!-- Info Overlay -->
                        <div class="absolute bottom-4 left-1/2 transform -translate-x-1/2 bg-black/60 p-4 rounded-lg border border-white/10 backdrop-blur-md shadow-xl text-center min-w-[200px]">
                            <div class="text-[10px] text-cyan-400 uppercase font-bold mb-1">æ¸¬é‡è·é›¢ DISTANCE</div>
                            <div class="text-3xl font-bold text-white mono-font"><span id="us-dist-val">---</span> cm</div>
                            <div class="mt-2 text-xs text-slate-300 font-mono border-t border-slate-600 pt-2">
                                é£›è¡Œæ™‚é–“ t = <span id="us-time-val" class="text-yellow-400">---</span> ms<br>
                            </div>
                        </div>
                    </div>

                    <!-- Metronome View -->
                    <div id="view-metronome" class="hidden w-full h-full flex flex-col justify-center items-center bg-slate-900 rounded-lg border border-slate-700 p-4 relative overflow-hidden">
                        <div class="absolute inset-0 bg-[radial-gradient(circle_at_center,_var(--tw-gradient-stops))] from-violet-900/20 to-transparent pointer-events-none"></div>
                        <div class="flex flex-col items-center justify-center gap-6 z-10">
                            <div id="metro-visual" class="beat-indicator"><span id="metro-beat-num">1</span></div>
                            <div class="text-center">
                                <div class="text-[10px] text-violet-400 uppercase tracking-widest font-bold mb-1">TEMPO (BPM)</div>
                                <div id="bpm-display" class="text-6xl font-bold text-white mono-font">120</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Controls -->
            <div class="p-4 md:p-8 max-w-4xl mx-auto pb-20">
                <!-- Lab Controls -->
                <div id="controls-lab" class="control-panel space-y-8 animate-fade-in">
                    <div class="bg-slate-800 p-1.5 rounded-lg flex shadow-sm border border-slate-700">
                        <button onclick="switchLabSource('generator')" id="btn-source-gen" class="btn-select active flex items-center justify-center gap-2"><span>ğŸ”Š æ’­æ”¾æ¨¡å¼</span></button>
                        <button onclick="switchLabSource('mic')" id="btn-source-mic" class="btn-select flex items-center justify-center gap-2"><span>ğŸ™ï¸ éŒ„éŸ³æ¨¡å¼</span></button>
                    </div>
                    <div id="panel-generator" class="space-y-6">
                        <button id="btn-lab-toggle" class="w-full py-4 bg-emerald-600 hover:bg-emerald-500 text-white rounded-xl font-bold shadow-lg transition transform active:scale-[0.98] flex items-center justify-center gap-2 text-lg"><span>â–¶ é–‹å§‹æ’­æ”¾</span></button>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div class="bg-slate-800 p-4 rounded-xl border border-slate-700">
                                <div class="flex justify-between mb-3 items-center"><label class="text-sm font-bold text-slate-300">é »ç‡ Frequency</label><span id="slider-freq-val" class="text-emerald-400 mono-font bg-slate-900 px-2 py-0.5 rounded text-sm">440 Hz</span></div>
                                <input type="range" id="slider-freq" min="20" max="2000" value="440" step="1">
                            </div>
                            <div class="bg-slate-800 p-4 rounded-xl border border-slate-700">
                                <div class="flex justify-between mb-3 items-center"><label class="text-sm font-bold text-slate-300">éŸ³é‡ Volume</label><span id="slider-vol-val" class="text-emerald-400 mono-font bg-slate-900 px-2 py-0.5 rounded text-sm">50%</span></div>
                                <input type="range" id="slider-vol" min="0" max="100" value="50">
                            </div>
                        </div>
                        <div class="bg-slate-800 p-4 rounded-xl border border-slate-700">
                            <label class="text-sm font-bold text-slate-300 block mb-3">æ³¢å½¢ Waveform (å½±éŸ¿éŸ³è‰²)</label>
                            <div class="grid grid-cols-4 gap-2">
                                <button class="btn-select active text-xs md:text-sm" data-wave="sine" onclick="setWave('sine', this)">æ­£å¼¦æ³¢<br><span class="opacity-50 text-[10px]">Sine</span></button>
                                <button class="btn-select text-xs md:text-sm" data-wave="square" onclick="setWave('square', this)">æ–¹æ³¢<br><span class="opacity-50 text-[10px]">Square</span></button>
                                <button class="btn-select text-xs md:text-sm" data-wave="sawtooth" onclick="setWave('sawtooth', this)">é‹¸é½’æ³¢<br><span class="opacity-50 text-[10px]">Saw</span></button>
                                <button class="btn-select text-xs md:text-sm" data-wave="triangle" onclick="setWave('triangle', this)">ä¸‰è§’æ³¢<br><span class="opacity-50 text-[10px]">Tri</span></button>
                            </div>
                            <p class="text-xs text-slate-500 mt-2 text-center">ğŸ’¡ è©¦è‘—åˆ‡æ›åˆ°ã€Œé »è­œæ¨¡å¼ (Spectrum)ã€ä¾†è§€å¯Ÿä¸åŒæ³¢å½¢çš„é »ç‡çµ„æˆå·®ç•°ã€‚</p>
                        </div>
                    </div>
                    <div id="panel-mic" class="hidden space-y-6">
                        <button id="btn-mic-toggle" class="w-full py-4 bg-emerald-600 hover:bg-emerald-500 text-white rounded-xl font-bold shadow-lg transition transform active:scale-[0.98] flex items-center justify-center gap-2 text-lg"><span>ğŸ™ï¸ å•Ÿå‹•éº¥å…‹é¢¨åˆ†æ</span></button>
                        <div class="bg-slate-800 p-4 rounded-xl border border-slate-700">
                            <div class="flex justify-between items-center mb-4"><div><label class="text-sm font-bold text-slate-300 block">ç’°å¢ƒé™å™ª</label><span class="text-[10px] text-slate-500">éæ¿¾èƒŒæ™¯é›œéŸ³</span></div><span id="noise-level-val" class="text-emerald-400 mono-font font-bold">0%</span></div>
                            <input type="range" id="slider-noise" min="0" max="100" value="0">
                        </div>
                        <p class="text-center text-xs text-slate-500 mt-4">æç¤ºï¼šè«‹å…è¨±ç€è¦½å™¨ä½¿ç”¨éº¥å…‹é¢¨æ¬Šé™ã€‚</p>
                    </div>
                </div>

                <!-- Mega Controls -->
                <div id="controls-megaphone" class="hidden space-y-8 animate-fade-in">
                    <div class="flex flex-col items-center justify-center space-y-6 py-8">
                         <button id="btn-mega-toggle" class="w-full max-w-md py-4 bg-orange-600 hover:bg-orange-500 text-white rounded-xl font-bold shadow-lg transition transform active:scale-[0.98] flex items-center justify-center gap-2 text-lg"><span>ğŸ“¢ é–‹å§‹åˆ†è²æŒ‘æˆ°</span></button>
                        <p class="text-slate-400 text-sm max-w-xs text-center">é»æ“Šé–‹å§‹å¾Œï¼Œå°è‘—è£ç½®å¶å–Šã€‚<br><span class="text-orange-400 text-xs">(ç‚ºé˜²æ­¢å›éŸ³ï¼Œæ­¤æ¨¡å¼ä¸æœƒæ’­æ”¾è²éŸ³)</span></button>
                    </div>
                    <div class="bg-slate-800 p-6 rounded-xl border border-slate-700">
                        <div class="flex justify-between mb-3 items-center"><label class="text-sm font-bold text-slate-300">éˆæ•åº¦èª¿æ•´ / é™å™ª</label><span id="mega-noise-val" class="text-orange-400 mono-font">30%</span></div>
                        <input type="range" id="slider-mega-noise" min="0" max="100" value="30">
                    </div>
                </div>

                <!-- Speed Controls -->
                <div id="controls-speed" class="hidden space-y-8 animate-fade-in">
                    <div class="bg-slate-800 p-4 rounded-xl border border-slate-700">
                        <label class="text-sm font-bold text-slate-300 block mb-3">é¸æ“‡ä»‹è³ª Medium</label>
                        <div class="grid grid-cols-3 gap-3">
                            <button class="btn-select active flex flex-col items-center py-4" onclick="setMedium('air', this)"><span class="text-2xl mb-1">â˜ï¸</span><span class="font-bold">æ°£é«” (ç©ºæ°£)</span></button>
                            <button class="btn-select flex flex-col items-center py-4" onclick="setMedium('water', this)"><span class="text-2xl mb-1">ğŸ’§</span><span class="font-bold">æ¶²é«” (æ°´)</span></button>
                            <button class="btn-select flex flex-col items-center py-4" onclick="setMedium('iron', this)"><span class="text-2xl mb-1">ğŸ”©</span><span class="font-bold">å›ºé«” (éµ)</span></button>
                        </div>
                    </div>
                    <div class="bg-slate-800 p-4 rounded-xl border border-slate-700">
                        <div class="flex justify-between mb-3 items-center"><div><label class="text-sm font-bold text-amber-400">ç’°å¢ƒæº«åº¦ Temperature</label><div class="text-[10px] text-slate-500">æº«åº¦è®ŠåŒ–å½±éŸ¿ä»‹è³ªå¯†åº¦èˆ‡å½ˆæ€§</div></div><span id="speed-temp-val" class="text-amber-400 mono-font bg-slate-900 px-3 py-1 rounded text-lg">20 Â°C</span></div>
                        <input type="range" id="slider-temp" min="-20" max="100" value="20" class="temp-slider">
                        <div class="flex justify-between text-[10px] text-slate-500 mt-1"><span>-20Â°C (å¯’å†·)</span><span>100Â°C (æ²¸é¨°)</span></div>
                    </div>
                    <button id="btn-send-pulse" class="w-full py-4 bg-blue-600 hover:bg-blue-500 text-white rounded-xl font-bold shadow-lg transition transform active:scale-[0.98] flex items-center justify-center gap-2 text-lg"><span>ğŸ“¡ ç™¼é€è²æ³¢è„ˆè¡</span></button>
                </div>

                <!-- Doppler Controls -->
                <div id="controls-doppler" class="hidden space-y-8 animate-fade-in">
                    <button id="btn-doppler-toggle" class="w-full py-4 bg-pink-600 hover:bg-pink-500 text-white rounded-xl font-bold shadow-lg transition transform active:scale-[0.98] flex items-center justify-center gap-2 text-lg"><span>ğŸš‘ é–‹å§‹æ¨¡æ“¬</span></button>
                    <div class="bg-slate-800 p-6 rounded-xl border border-slate-700 space-y-6">
                        <div>
                            <div class="flex justify-between mb-2 items-center"><label class="text-sm font-bold text-pink-400">è²æºç§»å‹•é€Ÿåº¦</label><span id="dop-vel-val" class="text-pink-400 mono-font bg-slate-900 px-2 py-0.5 rounded text-sm">0 km/h</span></div>
                            <input type="range" id="slider-dop-vel" min="0" max="1000" value="0" class="doppler-slider">
                            <div class="flex justify-between text-[10px] text-slate-500 mt-1"><span>éœæ­¢ (0)</span><span>éŸ³é€Ÿ (1235 km/h)</span></div>
                        </div>
                        <div>
                            <div class="flex justify-between mb-2 items-center"><label class="text-sm font-bold text-slate-300">åŸºç¤é »ç‡ (Base Freq)</label><span id="dop-freq-val" class="text-slate-300 mono-font bg-slate-900 px-2 py-0.5 rounded text-sm">440 Hz</span></div>
                            <input type="range" id="slider-dop-freq" min="200" max="800" value="440">
                        </div>
                        <div>
                            <div class="flex justify-between mb-2 items-center"><label class="text-sm font-bold text-slate-300">æ¨¡æ“¬éŸ³é‡ (Volume)</label><span id="dop-vol-val" class="text-slate-300 mono-font bg-slate-900 px-2 py-0.5 rounded text-sm">50%</span></div>
                            <input type="range" id="slider-dop-vol" min="0" max="100" value="50">
                        </div>
                    </div>
                </div>

                <!-- Sonic Boom Controls -->
                <div id="controls-sonicboom" class="hidden space-y-8 animate-fade-in">
                    <button id="btn-sb-toggle" class="w-full py-4 bg-rose-600 hover:bg-rose-500 text-white rounded-xl font-bold shadow-lg transition transform active:scale-[0.98] flex items-center justify-center gap-2 text-lg"><span>ğŸš€ é–‹å§‹éŸ³çˆ†æ¨¡æ“¬</span></button>
                    <div class="bg-slate-800 p-6 rounded-xl border border-slate-700 space-y-6">
                        <div>
                            <div class="flex justify-between mb-2 items-center"><label class="text-sm font-bold text-rose-400">é£›è¡Œé€Ÿåº¦ (é¦¬èµ« Mach)</label>
                                <div class="flex flex-col items-end">
                                    <span id="sb-slider-val" class="text-rose-400 mono-font bg-slate-900 px-2 py-0.5 rounded text-sm">0.0 M</span>
                                    <span id="sb-kmh-val" class="text-[10px] text-slate-500 font-mono mt-1">0 km/h</span>
                                </div>
                            </div>
                            <input type="range" id="slider-sb-mach" min="0" max="2.5" step="0.1" value="0" class="sonic-slider">
                            <div class="flex justify-between text-[10px] text-slate-500 mt-1">
                                <span>éœæ­¢ (0)</span>
                                <span>éŸ³é€Ÿ (1.0)</span>
                                <span>è¶…éŸ³é€Ÿ (2.5)</span>
                            </div>
                        </div>
                    </div>
                    <div class="text-center text-xs text-slate-400">
                        ç•¶é€Ÿåº¦è¶…é 1.0 Mach æ™‚ï¼Œè«‹è§€å¯Ÿå‰æ–¹å †ç–Šçš„ã€ŒéŸ³éšœã€èˆ‡å¾Œæ–¹çš„ã€Œé¦¬èµ«éŒã€ã€‚
                    </div>
                </div>

                <!-- Resonance Controls (New v2.6) -->
                <div id="controls-resonance" class="hidden space-y-8 animate-fade-in">
                    <button id="btn-res-toggle" class="w-full py-4 bg-yellow-600 hover:bg-yellow-500 text-white rounded-xl font-bold shadow-lg transition transform active:scale-[0.98] flex items-center justify-center gap-2 text-lg"><span>ğŸ· é–‹å§‹å…±æŒ¯å¯¦é©—</span></button>
                    <div class="bg-slate-800 p-6 rounded-xl border border-slate-700 space-y-6">
                        <div>
                            <div class="flex justify-between mb-2 items-center"><label class="text-sm font-bold text-yellow-400">é©…å‹•é »ç‡ (Driving Freq)</label><span id="res-drive-val" class="text-yellow-400 mono-font bg-slate-900 px-2 py-0.5 rounded text-sm">1.0 Hz</span></div>
                            <input type="range" id="slider-res-drive" min="0.5" max="3.0" step="0.1" value="1.0" class="res-slider">
                        </div>
                        <div>
                            <div class="flex justify-between mb-2 items-center"><label class="text-sm font-bold text-emerald-400">å›ºæœ‰é »ç‡ (Natural Freq)</label><span id="res-natural-val" class="text-emerald-400 mono-font bg-slate-900 px-2 py-0.5 rounded text-sm">1.5 Hz</span></div>
                            <input type="range" id="slider-res-natural" min="0.5" max="3.0" step="0.1" value="1.5" class="res-slider" style="--thumb-color: #10b981;">
                        </div>
                        <div>
                            <div class="flex justify-between mb-2 items-center"><label class="text-sm font-bold text-slate-400">é˜»å°¼ (Damping)</label><span id="res-damp-val" class="text-slate-400 mono-font bg-slate-900 px-2 py-0.5 rounded text-sm">0.05</span></div>
                            <input type="range" id="slider-res-damp" min="0.01" max="0.2" step="0.01" value="0.05">
                        </div>
                    </div>
                    <div class="text-center text-xs text-slate-400">
                        æç¤ºï¼šèª¿æ•´ã€Œé©…å‹•é »ç‡ã€ä½¿å…¶ç­‰æ–¼ã€Œå›ºæœ‰é »ç‡ã€ï¼Œè§€å¯ŸæŒ¯å¹…çš„åŠ‡çƒˆè®ŠåŒ–ã€‚
                    </div>
                </div>

                <!-- Ultrasound Controls -->
                <div id="controls-ultrasound" class="hidden space-y-8 animate-fade-in">
                    <button id="btn-ultrasound-pulse" class="w-full py-4 bg-cyan-600 hover:bg-cyan-500 text-white rounded-xl font-bold shadow-lg transition transform active:scale-[0.98] flex items-center justify-center gap-2 text-lg">
                        <span>ğŸ“¡ ç™¼å°„è¶…éŸ³æ³¢ (Pulse)</span>
                    </button>
                    
                    <div class="bg-slate-800 p-6 rounded-xl border border-slate-700 space-y-6">
                         <div>
                            <div class="flex justify-between mb-2 items-center">
                                <label class="text-sm font-bold text-cyan-400">éšœç¤™ç‰©è·é›¢ (Distance)</label>
                                <span id="us-slider-val" class="text-cyan-400 mono-font bg-slate-900 px-2 py-0.5 rounded text-sm">50 cm</span>
                            </div>
                            <input type="range" id="slider-us-dist" min="5" max="200" value="50" class="ultra-slider">
                            <div class="flex justify-between text-[10px] text-slate-500 mt-1">
                                <span>5 cm</span>
                                <span>200 cm</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="text-center text-xs text-slate-400">
                        æ¨¡æ“¬éŸ³é€Ÿï¼š343 m/s (20Â°C ç©ºæ°£)
                    </div>
                </div>

                <!-- Metronome Controls -->
                <div id="controls-metronome" class="hidden space-y-8 animate-fade-in">
                    <div class="flex flex-col items-center justify-center space-y-6 py-4">
                         <button id="btn-metro-toggle" class="w-full max-w-md py-4 bg-violet-600 hover:bg-violet-500 text-white rounded-xl font-bold shadow-lg transition transform active:scale-[0.98] flex items-center justify-center gap-2 text-lg"><span>â–¶ é–‹å§‹ç¯€æ‹</span></button>
                        <button id="btn-tap-tempo" class="w-32 py-2 bg-slate-700 hover:bg-slate-600 text-slate-200 rounded-lg font-bold border border-slate-600 transition active:scale-95">TAP æ¸¬é€Ÿ</button>
                    </div>
                    <div class="bg-slate-800 p-4 rounded-xl border border-slate-700">
                        <label class="text-sm font-bold text-slate-300 block mb-3">æ‹è™Ÿ Time Signature</label>
                        <div class="grid grid-cols-4 gap-2">
                            <button class="btn-select active" onclick="setTimeSignature(4, this)">4/4</button>
                            <button class="btn-select" onclick="setTimeSignature(3, this)">3/4</button>
                            <button class="btn-select" onclick="setTimeSignature(2, this)">2/4</button>
                            <button class="btn-select" onclick="setTimeSignature(1, this)">1/4</button>
                        </div>
                    </div>
                    <div class="bg-slate-800 p-6 rounded-xl border border-slate-700">
                        <div class="flex justify-between mb-3 items-center"><label class="text-sm font-bold text-violet-400">é€Ÿåº¦èª¿æ•´ (BPM)</label><div class="flex gap-2"><button onclick="adjBpm(-1)" class="w-8 h-8 bg-slate-700 rounded hover:bg-slate-600">-</button><button onclick="adjBpm(1)" class="w-8 h-8 bg-slate-700 rounded hover:bg-slate-600">+</button></div></div>
                        <input type="range" id="slider-bpm" min="30" max="250" value="120" class="metro-slider">
                        <div class="flex justify-between text-[10px] text-slate-500 mt-2"><span>30 (Largo)</span><span>250 (Presto)</span></div>
                    </div>
                    <div class="bg-slate-800 p-4 rounded-xl border border-slate-700">
                        <label class="text-sm font-bold text-slate-300 block mb-3">éŸ³è‰² Sound</label>
                        <div class="grid grid-cols-2 gap-3">
                            <button class="btn-select active flex items-center justify-center gap-2 py-3" onclick="setMetroSound('digital', this)"><span>ğŸ¤– é›»å­å—¶è²</span></button>
                            <button class="btn-select flex items-center justify-center gap-2 py-3" onclick="setMetroSound('wood', this)"><span>ğŸªµ æ©Ÿæ¢°æœ¨é­š</span></button>
                        </div>
                    </div>
                </div>

            </div>
        </main>
    </div>

    <!-- Help Modal -->
    <div id="info-modal" class="modal-backdrop">
        <div class="modal-content">
            <div class="flex justify-between items-center p-4 border-b border-slate-700 bg-slate-800/50">
                <h3 id="modal-title" class="text-lg font-bold text-white">èªªæ˜</h3>
                <button onclick="closeModal('info-modal')" class="text-slate-400 hover:text-white p-2">âœ•</button>
            </div>
            <div id="modal-body" class="p-6 overflow-y-auto prose prose-invert prose-sm max-w-none text-slate-300"></div>
            <div class="p-4 border-t border-slate-700 bg-slate-800/50 text-right"><button onclick="closeModal('info-modal')" class="px-4 py-2 bg-slate-700 hover:bg-slate-600 rounded text-sm text-white transition">é—œé–‰</button></div>
        </div>
    </div>

    <!-- Version Modal -->
    <div id="version-modal" class="modal-backdrop">
        <div class="modal-content">
            <div class="flex justify-between items-center p-4 border-b border-slate-700 bg-slate-800/50">
                <h3 class="text-lg font-bold text-white flex items-center gap-2">ğŸ•’ ç‰ˆæœ¬æ›´æ–°ç´€éŒ„</h3>
                <button onclick="closeModal('version-modal')" class="text-slate-400 hover:text-white p-2">âœ•</button>
            </div>
            <div class="p-0 overflow-y-auto max-h-[60vh]">
                <div class="divide-y divide-slate-700">
                    <!-- v2.6.1 -->
                    <div class="p-4 bg-slate-800/30">
                        <div class="flex justify-between items-baseline mb-2"><span class="text-emerald-400 font-bold">v2.6.1 (Graph Fix)</span><span class="text-xs text-slate-500">2024.12</span></div>
                        <ul class="list-disc list-inside text-sm text-slate-300 space-y-1">
                            <li>ä¿®æ­£ï¼šè§£æ±ºåè¦†åˆ‡æ›ã€Œé–‹å§‹/åœæ­¢ã€æ™‚ï¼Œå› éŸ³è¨Šé€£æ¥å †ç–Šå°è‡´æ³¢å½¢ç„¡æ³•é¡¯ç¤ºçš„ Bugã€‚</li>
                            <li>å„ªåŒ–ï¼šç¢ºä¿æ¯æ¬¡é‡å•Ÿå¯¦é©—æ™‚ï¼Œéƒ½æœƒæ¸…é™¤èˆŠçš„æ³¢å½¢ç·©å­˜ï¼Œé¿å…é¡¯ç¤ºæ®˜ç•™æ•¸æ“šã€‚</li>
                        </ul>
                    </div>
                    <!-- v2.6 -->
                    <div class="p-4 hover:bg-slate-800/20">
                        <div class="flex justify-between items-baseline mb-2"><span class="text-emerald-400 font-bold">v2.6 (Fix Resonance)</span><span class="text-xs text-slate-500">2024.12</span></div>
                        <ul class="list-disc list-inside text-sm text-slate-300 space-y-1">
                            <li>ä¿®æ­£ï¼šä½¿ç”¨å­æ­¥é€² (Sub-stepping) æŠ€è¡“ç©©å®šå…±æŒ¯æ¨¡æ“¬çš„ç‰©ç†é‹ç®—ï¼Œè§£æ±ºç‰©é«”äº‚æ“ºå‹•çš„å•é¡Œã€‚</li>
                        </ul>
                    </div>
                    <!-- v2.5.3 -->
                    <div class="p-4 hover:bg-slate-800/20">
                        <div class="flex justify-between items-baseline mb-2"><span class="text-emerald-400 font-bold">v2.5.3 (View Speed)</span><span class="text-xs text-slate-500">2024.12</span></div>
                        <ul class="list-disc list-inside text-sm text-slate-300 space-y-1">
                             <li>æ–°å¢ï¼šéŸ³çˆ†æ¨¡æ“¬ç•«é¢ä¸­ï¼Œå³ä¸Šè§’å¢åŠ  <strong>km/h</strong> é€Ÿåº¦é¡¯ç¤ºã€‚</li>
                        </ul>
                    </div>
                    <!-- v2.5.2 -->
                    <div class="p-4 hover:bg-slate-800/20">
                        <div class="flex justify-between items-baseline mb-2"><span class="text-slate-300 font-bold">v2.5.2 (Sonic Boom Speed)</span><span class="text-xs text-slate-500">2024.12</span></div>
                        <ul class="list-disc list-inside text-sm text-slate-300 space-y-1">
                             <li>æ–°å¢ï¼šéŸ³çˆ†æ¨¡æ“¬æ§åˆ¶å€å¢åŠ  <strong>km/h</strong> é€Ÿåº¦é¡¯ç¤ºã€‚</li>
                        </ul>
                    </div>
                    <!-- v2.5.1 -->
                    <div class="p-4 hover:bg-slate-800/20">
                        <div class="flex justify-between items-baseline mb-2"><span class="text-slate-300 font-bold">v2.5.1 (Silent Sonic Boom)</span><span class="text-xs text-slate-500">2024.12</span></div>
                        <ul class="list-disc list-inside text-sm text-slate-300 space-y-1">
                             <li>ä¿®æ­£ï¼šéŸ³çˆ†æ¨¡æ“¬ç§»é™¤è²éŸ³æ’­æ”¾ï¼Œå°ˆæ³¨æ–¼è¦–è¦ºåŒ–æ³¢å½¢èˆ‡é¦¬èµ«éŒå±•ç¤ºã€‚</li>
                        </ul>
                    </div>
                     <!-- v2.5 -->
                    <div class="p-4 hover:bg-slate-800/20">
                        <div class="flex justify-between items-baseline mb-2"><span class="text-slate-300 font-bold">v2.5 (Sonic Boom)</span><span class="text-xs text-slate-500">2024.12</span></div>
                        <ul class="list-disc list-inside text-sm text-slate-300 space-y-1">
                            <li>æ–°å¢ï¼š<strong>éŸ³çˆ†æ¨¡æ“¬æ•™å­¸å·¥å…·</strong>ã€‚å¯èª¿æ•´é¦¬èµ«æ•¸ (Mach)ï¼Œè§€å¯Ÿè²æ³¢å †ç–Šå½¢æˆçš„éŸ³éšœèˆ‡é¦¬èµ«éŒã€‚</li>
                            <li>æ–°å¢ï¼šéŸ³çˆ†ç›¸é—œçš„ç‰©ç†èªªæ˜èˆ‡ç”Ÿæ´»æ‡‰ç”¨ (æˆ°é¬¥æ©Ÿã€å¤ªç©ºæ¢­)ã€‚</li>
                        </ul>
                    </div>
                    <!-- v2.4.1 -->
                    <div class="p-4 hover:bg-slate-800/20">
                        <div class="flex justify-between items-baseline mb-2"><span class="text-slate-300 font-bold">v2.4.1 (UI Fix)</span><span class="text-xs text-slate-500">2024.12</span></div>
                        <ul class="list-disc list-inside text-sm text-slate-300 space-y-1">
                            <li>ä¿®æ­£ï¼šåˆ‡æ›ã€Œæ’­æ”¾æ¨¡å¼ã€èˆ‡ã€ŒéŒ„éŸ³æ¨¡å¼ã€æ™‚ï¼Œä¸»æ§åˆ¶æŒ‰éˆ•æ–‡å­—ç¾åœ¨æœƒç«‹å³æ›´æ–°ã€‚</li>
                            <li>å„ªåŒ–ï¼šçµ±ä¸€æ‰€æœ‰ä»‹é¢å…ƒç´ çš„å­˜å–æ–¹å¼ï¼Œæå‡ç©©å®šæ€§ã€‚</li>
                        </ul>
                    </div>
                    <!-- v2.4 -->
                    <div class="p-4 hover:bg-slate-800/20">
                        <div class="flex justify-between items-baseline mb-2"><span class="text-slate-300 font-bold">v2.4 (Fix)</span><span class="text-xs text-slate-500">2024.12</span></div>
                        <ul class="list-disc list-inside text-sm text-slate-300 space-y-1">
                            <li>ä¿®æ­£è²é€Ÿæ¨¡æ“¬å¯¦é©—ä¸­çš„è®Šæ•¸åç¨±éŒ¯èª¤ã€‚</li>
                            <li>ä¿®æ­£å¤§è²å…¬æ¨¡å¼ä¸‹çš„ç¹ªåœ–éŒ¯èª¤ã€‚</li>
                        </ul>
                    </div>
                    <!-- v2.3 -->
                    <div class="p-4 hover:bg-slate-800/20">
                        <div class="flex justify-between items-baseline mb-2"><span class="text-slate-300 font-bold">v2.3 (Stable)</span><span class="text-xs text-slate-500">2024.12</span></div>
                        <ul class="list-disc list-inside text-sm text-slate-300 space-y-1">
                            <li>ç§»é™¤æ‰‹å‹•å‡çµæŒ‰éˆ•ï¼Œä¿ç•™åœæ­¢æ™‚è‡ªå‹•ç¶­æŒæ³¢å½¢çš„åŠŸèƒ½ã€‚</li>
                            <li>ä¿®æ­£æ‰€æœ‰å·²çŸ¥éŒ¯èª¤ (classList, frequencyBinCount, resize issue)ã€‚</li>
                        </ul>
                    </div>
                    <!-- v2.2 -->
                    <div class="p-4 hover:bg-slate-800/20">
                        <div class="flex justify-between items-baseline mb-2"><span class="text-slate-300 font-bold">v2.2 (Hold)</span><span class="text-xs text-slate-500">2024.12</span></div>
                        <ul class="list-disc list-inside text-sm text-slate-300 space-y-1">
                            <li>æ–°å¢åŠŸèƒ½ï¼š<strong>æ³¢å½¢ä¿ç•™ (Waveform Hold)</strong>ã€‚ç•¶åœæ­¢æ’­æ”¾æ™‚ï¼Œæœ€å¾Œä¸€åˆ»çš„æ³¢å½¢æœƒä¿ç•™åœ¨ç•«é¢ä¸Šï¼Œæ–¹ä¾¿è§€å¯Ÿã€‚</li>
                            <li>æ–°å¢åŠŸèƒ½ï¼š<strong>é »è­œåˆ†æå„€ (Spectrum FFT)</strong>ã€‚æ”¯æ´é »è­œé¡¯ç¤ºèˆ‡ä¿ç•™ (å¾ŒçºŒç‰ˆæœ¬å·²ç°¡åŒ–ç‚ºç´”æ³¢å½¢)ã€‚</li>
                        </ul>
                    </div>
                    <!-- v2.1 -->
                    <div class="p-4 hover:bg-slate-800/20">
                        <div class="flex justify-between items-baseline mb-2"><span class="text-slate-300 font-bold">v2.1 (Fix)</span><span class="text-xs text-slate-500">2024.12</span></div>
                        <ul class="list-disc list-inside text-sm text-slate-300 space-y-1">
                            <li>ä¿®æ­£æ³¢å½¢æ“·å–æ™‚ï¼Œå› è¢å¹•æ—‹è½‰æˆ–èª¿æ•´å¤§å°å°è‡´ç•«é¢æ¶ˆå¤±çš„å•é¡Œã€‚</li>
                            <li>ä¿®å¾©æ¨¡å¼åˆ‡æ›æ™‚å¯èƒ½ç™¼ç”Ÿçš„è…³æœ¬éŒ¯èª¤ (Reference Error)ã€‚</li>
                        </ul>
                    </div>
                    <!-- v2.0 -->
                    <div class="p-4 hover:bg-slate-800/20">
                        <div class="flex justify-between items-baseline mb-2"><span class="text-slate-300 font-bold">v2.0</span><span class="text-xs text-slate-500">2024.12</span></div>
                        <ul class="list-disc list-inside text-sm text-slate-300 space-y-1">
                            <li>æ–°å¢ã€Œè¶…éŸ³æ³¢å¯¦é©—å®¤ã€ï¼šæ¨¡æ“¬å›è²å®šä½ (Echolocation) èˆ‡å€’è»Šé›·é”åŸç†ã€‚</li>
                        </ul>
                    </div>
                </div>
            </div>
             <div class="p-4 border-t border-slate-700 bg-slate-800/50 text-right"><button onclick="closeModal('version-modal')" class="px-4 py-2 bg-slate-700 hover:bg-slate-600 rounded text-sm text-white transition">é—œé–‰</button></div>
        </div>
    </div>

    <script>
        // =========================================
        //           COPY TO: script.js
        // =========================================

        // --- GLOBAL STATE ---
        let audioCtx, analyser, oscillator, gainNode, microphoneStream, microphoneSource, lowShelfFilter, highShelfFilter;
        let state = {
            mode: 'lab', labSource: 'generator', isRunning: false, waveType: 'sine', maxDb: 0,
            medium: 'air', temp: 20, pulseX: -100, isPulseRunning: false, calculatedSpeed: 343,
            bpm: 120, metroSound: 'digital', nextNoteTime: 0.0, metroTimerID: null, scheduleAheadTime: 0.1, lookahead: 25.0, tapTimes: [], beatsPerMeasure: 4, currentBeatCount: 0,
            dopVel: 0, dopBaseFreq: 440, dopSrcX: -50, dopObsX: 0, dopWaves: [], dopVol: 50, frameCount: 0,
            // Ultrasound
            usPulseX: -100, usPulseState: 0, usTargetDist: 50, usTime: 0, usWaves: [], usMeasuredDist: null,
            // Sonic Boom
            sbMach: 0.0, sbWaves: [], sbSourceX: -150,
            // Resonance
            resDriveFreq: 1.0, resNaturalFreq: 1.5, resDamping: 0.05, resMassY: 0, resVelY: 0, resTime: 0, resHistory: []
        };
        let animationId;
        // Data buffers for visualization holding
        let capturedWaveform = null;

        const noteStrings = ["C", "C#", "D", "D#", "E", "F", "F#", "G", "G#", "A", "A#", "B"];
        const solfegeStrings = ["Do", "Di/Ra", "Re", "Ri/Me", "Mi", "Fa", "Fi/Se", "Sol", "Si/Le", "La", "Li/Te", "Ti"];

        const els = {}; // Populate immediately

        // Populate elements immediately
        const ids = [
            'sidebar', 'sidebar-overlay', 'section-title', 
            'view-lab', 'view-megaphone', 'view-speed', 'view-metronome', 'view-doppler', 'view-ultrasound', 'view-sonicboom', 'view-resonance',
            'controls-lab', 'controls-megaphone', 'controls-speed', 'controls-metronome', 'controls-doppler', 'controls-ultrasound', 'controls-sonicboom', 'controls-resonance',
            'panel-generator', 'panel-mic', 
            'btn-source-gen', 'btn-source-mic', 
            'oscilloscope',
            'display-freq', 'display-note', 'display-solfege', 'slider-freq', 'slider-vol', 'slider-noise', 'btn-lab-toggle', 'btn-mic-toggle',
            'db-bar-fill', 'db-current', 'db-max', 'slider-mega-noise', 'btn-mega-toggle',
            'speed-canvas', 'speed-val', 'speed-medium-label', 'slider-temp', 'speed-temp-val', 'btn-send-pulse',
            'metro-visual', 'metro-beat-num', 'bpm-display', 'slider-bpm', 'btn-metro-toggle', 'btn-tap-tempo',
            'doppler-canvas', 'slider-dop-vel', 'slider-dop-freq', 'slider-dop-vol', 'dop-vel-val', 'dop-freq-val', 'dop-vol-val', 'dop-src-freq', 'dop-obs-freq', 'btn-doppler-toggle',
            'ultrasound-canvas', 'slider-us-dist', 'us-slider-val', 'us-dist-val', 'us-time-val', 'btn-ultrasound-pulse',
            'sonicboom-canvas', 'slider-sb-mach', 'sb-slider-val', 'sb-mach-display', 'btn-sb-toggle', 'sb-kmh-val', 'sb-view-kmh',
            'resonance-canvas', 'resonance-graph', 'slider-res-drive', 'slider-res-natural', 'slider-res-damp', 'res-drive-val', 'res-natural-val', 'res-damp-val', 'btn-res-toggle', 'res-warning'
        ];
        
        // Robust ID Mapping
        ids.forEach(id => {
            const el = document.getElementById(id);
            if (el) {
                els[id] = el; 
                const camel = id.replace(/-([a-z])/g, (g) => g[1].toUpperCase());
                els[camel] = el; 
            }
        });

        if(document.getElementById('sidebar-overlay')) els.overlay = document.getElementById('sidebar-overlay');

        // --- INIT ---
        document.addEventListener('DOMContentLoaded', () => {
            els.ctx = els.oscilloscope.getContext('2d');
            els.speedCtx = els.speedCanvas.getContext('2d');
            els.dopCtx = els.dopplerCanvas.getContext('2d');
            els.usCtx = els.ultrasoundCanvas.getContext('2d');
            els.sbCtx = els.sonicboomCanvas.getContext('2d');
            els.resCtx = els.resonanceCanvas.getContext('2d');
            els.resGraphCtx = els.resonanceGraph.getContext('2d');
            
            document.getElementById('btn-menu').addEventListener('click', () => { els.sidebar.classList.toggle('open'); document.getElementById('sidebar-overlay').classList.toggle('hidden'); });
            document.getElementById('sidebar-overlay').addEventListener('click', () => { els.sidebar.classList.remove('open'); document.getElementById('sidebar-overlay').classList.add('hidden'); });
            
            els.btnLabToggle.addEventListener('click', window.toggleLab);
            els.btnMicToggle.addEventListener('click', window.toggleLab);
            els.sliderFreq.addEventListener('input', e => { document.getElementById('slider-freq-val').textContent = e.target.value + " Hz"; if(oscillator) oscillator.frequency.value = e.target.value; });
            els.sliderVol.addEventListener('input', e => { document.getElementById('slider-vol-val').textContent = e.target.value + "%"; if(gainNode) gainNode.gain.value = e.target.value/100; });
            els.sliderNoise.addEventListener('input', e => { document.getElementById('noise-level-val').textContent = e.target.value + "%"; if(state.isRunning && state.labSource==='mic') applyNoise(e.target.value); });

            els.btnMegaToggle.addEventListener('click', () => { if(state.isRunning && state.mode === 'megaphone') stopAll(); else startMic(true); });
            els.sliderMegaNoise.addEventListener('input', e => { document.getElementById('mega-noise-val').textContent = e.target.value + "%"; if(state.isRunning && state.mode === 'megaphone') applyNoise(e.target.value); });

            els.sliderTemp.addEventListener('input', e => { state.temp = parseInt(e.target.value); document.getElementById('speed-temp-val').textContent = state.temp + " Â°C"; updateSpeedPhysics(); });
            els.btnSendPulse.addEventListener('click', () => { state.pulseX = 0; state.isPulseRunning = true; });

            els.sliderBpm.addEventListener('input', e => { state.bpm = parseInt(e.target.value); els.bpmDisplay.textContent = state.bpm; });
            els.btnMetroToggle.addEventListener('click', () => { if(state.isRunning && state.mode === 'metronome') stopAll(); else startMetronome(); });
            els.btnTapTempo.addEventListener('click', handleTapTempo);

            els.sliderDopVel.addEventListener('input', e => { state.dopVel = parseInt(e.target.value); els.dopVelVal.textContent = state.dopVel + " km/h"; });
            els.sliderDopFreq.addEventListener('input', e => { state.dopBaseFreq = parseInt(e.target.value); els.dopFreqVal.textContent = state.dopBaseFreq + " Hz"; els.dopSrcFreq.textContent = state.dopBaseFreq; });
            els.sliderDopVol.addEventListener('input', e => { state.dopVol = parseInt(e.target.value); els.dopVolVal.textContent = state.dopVol + "%"; });
            els.btnDopplerToggle.addEventListener('click', () => { if(state.isRunning && state.mode === 'doppler') stopAll(); else startDoppler(); });

            els.sliderUsDist.addEventListener('input', e => {
                state.usTargetDist = parseInt(e.target.value);
                els.usSliderVal.textContent = state.usTargetDist + " cm";
                if (state.usMeasuredDist !== null) { state.usMeasuredDist = null; els.usDistVal.textContent = "---"; els.usTimeVal.textContent = "---"; }
                if (!state.isRunning) drawUltrasoundFrame(); 
            });
            els.btnUltrasoundPulse.addEventListener('click', startUltrasoundPulse);

            els.sliderSbMach.addEventListener('input', e => { 
                state.sbMach = parseFloat(e.target.value); 
                els.sbSliderVal.textContent = state.sbMach + " M";
                const kmh = Math.round(state.sbMach * 1234.8);
                els.sbKmhVal.textContent = kmh + " km/h";
                if(els.sbViewKmh) els.sbViewKmh.textContent = kmh; 
                els.sbMachDisplay.textContent = state.sbMach;
            });
            els.btnSbToggle.addEventListener('click', () => { if(state.isRunning && state.mode === 'sonicboom') stopAll(); else startSonicBoom(); });

            els.sliderResDrive.addEventListener('input', e => { state.resDriveFreq = parseFloat(e.target.value); els.resDriveVal.textContent = state.resDriveFreq + " Hz"; });
            els.sliderResNatural.addEventListener('input', e => { state.resNaturalFreq = parseFloat(e.target.value); els.resNaturalVal.textContent = state.resNaturalFreq + " Hz"; });
            els.sliderResDamp.addEventListener('input', e => { state.resDamping = parseFloat(e.target.value); els.resDampVal.textContent = state.resDamping; });
            els.btnResToggle.addEventListener('click', () => { if(state.isRunning && state.mode === 'resonance') stopAll(); else startResonance(); });

            handleResize();
            window.addEventListener('resize', handleResize);
        });

        function handleResize() {
            [els.oscilloscope, els.speedCanvas, els.dopplerCanvas, els.ultrasoundCanvas, els.sonicboomCanvas, els.resonanceCanvas, els.resonanceGraph].forEach(c => { 
                if(c && c.parentElement) { c.width=c.parentElement.clientWidth; c.height=c.parentElement.clientHeight; }
            });
            if(state.mode==='speed') initParticles();
            if(state.mode==='doppler') initDopplerView();
            if(state.mode==='ultrasound') drawUltrasoundFrame();
            if(state.mode==='sonicboom') initSonicBoomView();
            if(state.mode==='resonance') initResonanceView();
            if(state.mode==='lab') draw(); 
        }

        window.switchMode = function(mode) {
            stopAll();
            if(window.innerWidth <= 768) { els.sidebar.classList.remove('open'); document.getElementById('sidebar-overlay').classList.add('hidden'); }
            state.mode = mode;
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            const btn = document.getElementById(`nav-${mode}`);
            if (btn) btn.classList.add('active');
            
            [els.viewLab, els.viewMegaphone, els.viewSpeed, els.viewMetronome, els.viewDoppler, els.viewUltrasound, els.viewSonicboom, els.viewResonance].forEach(e => e?.classList.add('hidden'));
            [els.controlsLab, els.controlsMegaphone, els.controlsSpeed, els.controlsMetronome, els.controlsDoppler, els.controlsUltrasound, els.controlsSonicboom, els.controlsResonance].forEach(e => e?.classList.add('hidden'));

            if(mode === 'lab') {
                els.sectionTitle.innerHTML = '<span class="w-2 h-6 bg-emerald-500 rounded-full inline-block"></span> æ³¢å½¢è§€å¯Ÿå¯¦é©—';
                els.viewLab.classList.remove('hidden'); els.controlsLab.classList.remove('hidden');
                draw(); 
            } else if (mode === 'megaphone') {
                els.sectionTitle.innerHTML = '<span class="w-2 h-6 bg-orange-500 rounded-full inline-block"></span> å¤§è²å…¬æŒ‘æˆ°';
                els.viewMegaphone.classList.remove('hidden'); els.controlsMegaphone.classList.remove('hidden');
            } else if (mode === 'speed') {
                els.sectionTitle.innerHTML = '<span class="w-2 h-6 bg-blue-500 rounded-full inline-block"></span> è²é€Ÿèˆ‡ä»‹è³ªæ¨¡æ“¬';
                els.viewSpeed.classList.remove('hidden'); els.controlsSpeed.classList.remove('hidden');
                els.speedCanvas.width = els.speedCanvas.parentElement.clientWidth; els.speedCanvas.height = els.speedCanvas.parentElement.clientHeight;
                updateSpeedPhysics(); initParticles(); requestAnimationFrame(drawSpeedLoop);
            } else if (mode === 'metronome') {
                els.sectionTitle.innerHTML = '<span class="w-2 h-6 bg-violet-500 rounded-full inline-block"></span> ç¯€æ‹å¤§å¸«';
                els.viewMetronome.classList.remove('hidden'); els.controlsMetronome.classList.remove('hidden');
            } else if (mode === 'doppler') { 
                els.sectionTitle.innerHTML = '<span class="w-2 h-6 bg-pink-500 rounded-full inline-block"></span> éƒ½åœå‹’æ•ˆæ‡‰æ¨¡æ“¬';
                els.viewDoppler.classList.remove('hidden'); els.controlsDoppler.classList.remove('hidden');
                els.dopplerCanvas.width = els.dopplerCanvas.parentElement.clientWidth; els.dopplerCanvas.height = els.dopplerCanvas.parentElement.clientHeight;
                initDopplerView();
            } else if (mode === 'sonicboom') {
                els.sectionTitle.innerHTML = '<span class="w-2 h-6 bg-rose-500 rounded-full inline-block"></span> éŸ³çˆ†æ¨¡æ“¬';
                els.viewSonicboom.classList.remove('hidden'); els.controlsSonicboom.classList.remove('hidden');
                els.sonicboomCanvas.width = els.sonicboomCanvas.parentElement.clientWidth; els.sonicboomCanvas.height = els.sonicboomCanvas.parentElement.clientHeight;
                initSonicBoomView();
            } else if (mode === 'resonance') {
                els.sectionTitle.innerHTML = '<span class="w-2 h-6 bg-yellow-500 rounded-full inline-block"></span> å…±æŒ¯å¯¦é©—';
                els.viewResonance.classList.remove('hidden'); els.controlsResonance.classList.remove('hidden');
                handleResize();
                initResonanceView();
            } else { 
                els.sectionTitle.innerHTML = '<span class="w-2 h-6 bg-cyan-500 rounded-full inline-block"></span> è¶…éŸ³æ³¢å›è²å®šä½';
                els.viewUltrasound.classList.remove('hidden'); els.controlsUltrasound.classList.remove('hidden');
                els.ultrasoundCanvas.width = els.ultrasoundCanvas.parentElement.clientWidth; els.ultrasoundCanvas.height = els.ultrasoundCanvas.parentElement.clientHeight;
                state.usMeasuredDist = null;
                els.usDistVal.textContent = "---"; 
                els.usTimeVal.textContent = "---";
                drawUltrasoundFrame();
            }
        };

        window.toggleLab = function() { if (state.isRunning) stopAll(); else startLab(); };
        
        window.switchLabSource = function(src) { 
            if(state.isRunning && state.mode==='lab') { 
                stopAll(); 
                state.labSource=src; 
                updateSourceUI(); 
                startLab(); 
            } else { 
                state.labSource=src; 
                updateSourceUI(); 
                updateLabStatus(false); 
            } 
        };
        
        window.setWave = function(t, b) { state.waveType=t; document.querySelectorAll('[data-wave]').forEach(x=>x.classList.remove('active')); b.classList.add('active'); if(oscillator) oscillator.type=t; };
        window.resetMaxDb = function() { state.maxDb=0; els.dbMax.textContent="0 dB"; };
        window.setMedium = function(m, btn) { state.medium = m; document.querySelectorAll('#controls-speed .btn-select').forEach(b => b.classList.remove('active')); btn.classList.add('active'); updateSpeedPhysics(); initParticles(); };
        window.setTimeSignature = function(num, btn) { state.beatsPerMeasure = num; document.querySelectorAll('#controls-metronome .grid button').forEach(b => b.classList.remove('active')); btn.classList.add('active'); };
        window.setMetroSound = function(type, btn) { state.metroSound = type; document.querySelectorAll('#controls-metronome .grid button.py-3').forEach(b => b.classList.remove('active')); btn.classList.add('active'); };
        window.adjBpm = function(delta) { let newBpm = state.bpm + delta; if (newBpm >= 30 && newBpm <= 250) { state.bpm = newBpm; els.sliderBpm.value = state.bpm; els.bpmDisplay.textContent = state.bpm; } };
        
        window.openCurrentHelp = function() { 
            document.getElementById('info-modal').classList.add('open');
            const t = document.getElementById('modal-title'); const b = document.getElementById('modal-body');
            if (state.mode === 'lab') { 
                t.textContent="æ³¢å½¢è§€å¯Ÿèªªæ˜"; 
                b.innerHTML=`
                    <h4 class="text-emerald-400 font-bold mb-2">æ³¢å½¢è§€å¯Ÿ (Waveform)</h4>
                    <p class="mb-2">ç¤ºæ³¢å™¨é¡¯ç¤ºçš„æ˜¯è²æ³¢éš¨æ™‚é–“è®ŠåŒ–çš„å½¢ç‹€ (Time Domain)ã€‚</p>
                    <ul class="list-disc pl-4 space-y-2 mb-4">
                        <li><strong>æ­£å¼¦æ³¢ (Sine)</strong>ï¼šæœ€ç´”æ·¨çš„è²éŸ³ï¼Œæ³¢å½¢åœ“æ»‘ã€‚</li>
                        <li><strong>æ–¹æ³¢ (Square)</strong>ï¼šè½èµ·ä¾†åƒé›»å­éŠæˆ²çš„è²éŸ³ï¼Œæ³¢å½¢æ–¹æ­£ã€‚</li>
                        <li><strong>é‹¸é½’æ³¢ (Sawtooth)</strong>ï¼šè½èµ·ä¾†å°–éŠ³ï¼Œæ³¢å½¢åƒé‹¸é½’ã€‚</li>
                    </ul>`; 
            } else if (state.mode === 'megaphone') { 
                t.textContent="åˆ†è²èªªæ˜"; 
                b.innerHTML=`<h4 class="text-orange-400 font-bold mb-2">åˆ†è² (dB)</h4><p>æ¸¬é‡è²éŸ³å¼·åº¦çš„å–®ä½ã€‚</p>`; 
            } else if (state.mode === 'speed') { 
                t.textContent="è²é€Ÿç‰©ç†å…¬å¼"; 
                b.innerHTML=`<h4 class="text-blue-400 font-bold mb-2">ä¸åŒä»‹è³ªçš„è²é€Ÿè¨ˆç®—</h4><div class="formula-box"><div class="font-bold text-white mb-1">1. æ°£é«” (ç©ºæ°£)</div>v â‰ˆ 331.5 + 0.607 T<br></div>`; 
            } else if (state.mode === 'metronome') {
                t.textContent="ç¯€æ‹å™¨èªªæ˜";
                b.innerHTML=`<h4 class="text-violet-400 font-bold mb-2">BPM & æ‹è™Ÿ</h4><ul class="list-disc pl-4 space-y-1"><li><strong>BPM</strong>ï¼šæ¯åˆ†é˜æ‹æ•¸ã€‚</li></ul>`;
            } else if (state.mode === 'ultrasound') {
                t.textContent="è¶…éŸ³æ³¢èªªæ˜";
                b.innerHTML=`<h4 class="text-cyan-400 font-bold mb-2">å›è²å®šä½åŸç†</h4><p>ç™¼å°„è²æ³¢ â†’ ç¢°åˆ°ç‰©é«”åå°„ â†’ æ¥æ”¶å›è²ã€‚</p>`;
            } else if (state.mode === 'sonicboom') {
                t.textContent="éŸ³çˆ†èªªæ˜";
                b.innerHTML=`<h4 class="text-rose-400 font-bold mb-2">ä»€éº¼æ˜¯éŸ³çˆ†ï¼Ÿ</h4><p>ç•¶ç‰©é«”é€Ÿåº¦æ¥è¿‘æˆ–è¶…ééŸ³é€Ÿï¼ˆ1 Machï¼‰æ™‚ï¼Œè²æ³¢å †ç–Šå½¢æˆã€ŒéŸ³éšœã€æˆ–ã€Œé¦¬èµ«éŒã€ã€‚</p>`;
            } else if (state.mode === 'resonance') {
                t.textContent="å…±æŒ¯èªªæ˜";
                b.innerHTML=`<h4 class="text-yellow-400 font-bold mb-2">ä»€éº¼æ˜¯å…±æŒ¯ï¼Ÿ</h4><p>ç•¶å¤–åŠ›é©…å‹•çš„é »ç‡ç­‰æ–¼ç‰©é«”çš„ã€Œå›ºæœ‰é »ç‡ã€æ™‚ï¼ŒæŒ¯å¹…æœƒæ€¥åŠ‡å¢åŠ ã€‚</p>`;
            } else { // Doppler
                t.textContent="éƒ½åœå‹’æ•ˆæ‡‰èªªæ˜";
                b.innerHTML=`<h4 class="text-pink-400 font-bold mb-2">åŸç†èˆ‡æ‡‰ç”¨</h4><p>ç•¶è²æºèˆ‡è§€å¯Ÿè€…æœ‰ç›¸å°é‹å‹•æ™‚ï¼Œè½åˆ°çš„é »ç‡æœƒç™¼ç”Ÿè®ŠåŒ–ã€‚</p>`;
            }
        };
        window.openVersionHistory = function() { document.getElementById('version-modal').classList.add('open'); };
        window.closeModal = function(id) { document.getElementById(id).classList.remove('open'); };

        function initAudio() {
            if (!audioCtx) {
                audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                analyser = audioCtx.createAnalyser(); 
                analyser.fftSize = 2048; 
                lowShelfFilter = audioCtx.createBiquadFilter(); lowShelfFilter.type = "lowshelf"; lowShelfFilter.frequency.value = 200;
                highShelfFilter = audioCtx.createBiquadFilter(); highShelfFilter.type = "highshelf"; highShelfFilter.frequency.value = 3000;
                lowShelfFilter.connect(highShelfFilter);
            }
            if (audioCtx.state === 'suspended') audioCtx.resume();
        }

        function stopAll() {
            // FIX 2.6.1: Disconnect analyser to prevent graph overload
            if (analyser) {
                try { analyser.disconnect(); } catch(e) {}
            }

            // FIX: Capture data logic
            if (state.mode === 'lab' && analyser && state.isRunning) {
                if (!capturedWaveform || capturedWaveform.length !== analyser.frequencyBinCount) {
                    capturedWaveform = new Uint8Array(analyser.frequencyBinCount);
                }
                analyser.getByteTimeDomainData(capturedWaveform);
            }

            if (oscillator) { try{oscillator.stop()}catch(e){} oscillator.disconnect(); oscillator=null; }
            if (microphoneSource) { microphoneSource.disconnect(); if(microphoneStream) microphoneStream.getTracks().forEach(t=>t.stop()); }
            if (gainNode) gainNode.disconnect();
            state.isRunning = false; cancelAnimationFrame(animationId);
            
            // Reset UI
            clearTimeout(state.metroTimerID);
            if(els.btnMetroToggle) {
                els.btnMetroToggle.innerHTML = "<span>â–¶ é–‹å§‹ç¯€æ‹</span>";
                els.btnMetroToggle.classList.remove('bg-red-500', 'hover:bg-red-600'); els.btnMetroToggle.classList.add('bg-violet-600', 'hover:bg-violet-500');
            }
            if(els.metroVisual) {
                els.metroVisual.classList.remove('active-weak', 'active-strong');
                state.currentBeatCount = 0; els.metroBeatNum.textContent = "1";
            }
            if(els.btnDopplerToggle) {
                els.btnDopplerToggle.innerHTML = "<span>ğŸš‘ é–‹å§‹æ¨¡æ“¬</span>";
                els.btnDopplerToggle.classList.remove('bg-red-500', 'hover:bg-red-600'); els.btnDopplerToggle.classList.add('bg-pink-600', 'hover:bg-pink-500');
            }
            if(els.btnSbToggle) {
                els.btnSbToggle.innerHTML = "<span>ğŸš€ é–‹å§‹éŸ³çˆ†æ¨¡æ“¬</span>";
                els.btnSbToggle.classList.remove('bg-red-500', 'hover:bg-red-600'); els.btnSbToggle.classList.add('bg-rose-600', 'hover:bg-rose-500');
            }
            if(els.btnResToggle) {
                els.btnResToggle.innerHTML = "<span>ğŸ· é–‹å§‹å…±æŒ¯å¯¦é©—</span>";
                els.btnResToggle.classList.remove('bg-red-500', 'hover:bg-red-600'); els.btnResToggle.classList.add('bg-yellow-600', 'hover:bg-yellow-500');
            }
            
            updateLabStatus(false);
            if(els.btnMegaToggle) {
                els.btnMegaToggle.innerHTML = "<span>ğŸ“¢ é–‹å§‹åˆ†è²æŒ‘æˆ°</span>";
                els.btnMegaToggle.classList.remove('bg-red-500', 'hover:bg-red-600'); els.btnMegaToggle.classList.add('bg-orange-600', 'hover:bg-orange-500');
            }
            
            state.usPulseState = 0; state.usWaves = [];
            if(els.sliderUsDist) els.sliderUsDist.disabled = false;
            if(els.resWarning) els.resWarning.classList.add('hidden');

            if (state.mode === 'lab') draw();
        }

        function startLab() {
            initAudio(); 
            stopAll();
            
            // FIX 2.6.1: Reset captured data to force fresh draw
            capturedWaveform = null;

            if (state.labSource === 'generator') {
                oscillator = audioCtx.createOscillator(); 
                gainNode = audioCtx.createGain();
                oscillator.type = state.waveType; 
                oscillator.frequency.value = els.sliderFreq.value; 
                gainNode.gain.value = els.sliderVol.value / 100;
                
                // Reconnect chain
                oscillator.connect(gainNode); 
                gainNode.connect(analyser); 
                analyser.connect(audioCtx.destination);
                
                oscillator.start(); 
                updateLabStatus(true);
            } else { 
                startMic(false); 
            }
            state.isRunning = true; 
            draw();
        }
        
        async function startMic(forMegaphone) {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: { echoCancellation: true, noiseSuppression: true, autoGainControl: false } });
                microphoneStream = stream; 
                microphoneSource = audioCtx.createMediaStreamSource(stream);
                microphoneSource.connect(lowShelfFilter); 
                applyNoise(forMegaphone ? els.sliderMegaNoise.value : els.sliderNoise.value); 
                
                // Reconnect chain
                highShelfFilter.connect(analyser); 
                // Analyser NOT connected to destination for mic to prevent feedback loop
                
                if(forMegaphone) { 
                    els.btnMegaToggle.innerHTML = "<span>â¹ åœæ­¢æŒ‘æˆ°</span>"; 
                    els.btnMegaToggle.classList.replace('bg-orange-600', 'bg-red-500'); 
                    els.btnMegaToggle.classList.replace('hover:bg-orange-500', 'hover:bg-red-600'); 
                } else { 
                    updateLabStatus(true); 
                }
                state.isRunning = true; 
                draw();
            } catch (err) { alert("ç„¡æ³•å­˜å–éº¥å…‹é¢¨: " + err); stopAll(); }
        }

        function updateLabStatus(active) {
            const txt = active ? "<span>â¹ åœæ­¢</span>" : (state.labSource === 'generator' ? "<span>â–¶ é–‹å§‹æ’­æ”¾</span>" : "<span>ğŸ™ï¸ å•Ÿå‹•éº¥å…‹é¢¨åˆ†æ</span>");
            const add = active ? ['bg-red-500', 'hover:bg-red-600'] : ['bg-emerald-600', 'hover:bg-emerald-500'];
            const rem = active ? ['bg-emerald-600', 'hover:bg-emerald-500'] : ['bg-red-500', 'hover:bg-red-600'];
            if(els.btnLabToggle) { els.btnLabToggle.innerHTML = txt; els.btnLabToggle.classList.remove(...rem); els.btnLabToggle.classList.add(...add); }
            if(els.btnMicToggle) { els.btnMicToggle.innerHTML = txt; els.btnMicToggle.classList.remove(...rem); els.btnMicToggle.classList.add(...add); }
        }

        function updateSourceUI() { 
            const gen = els.btnSourceGen; 
            const mic = els.btnSourceMic; 
            const pGen = els.panelGenerator;
            const pMic = els.panelMic;

            if(state.labSource==='generator') { 
                gen.classList.add('active'); mic.classList.remove('active'); 
                pGen.classList.remove('hidden'); pMic.classList.add('hidden'); 
            } else { 
                mic.classList.add('active'); gen.classList.remove('active'); 
                pGen.classList.add('hidden'); pMic.classList.remove('hidden'); 
            } 
        }

        function applyNoise(v) { const db = -1*(v/100)*40; if(lowShelfFilter) { lowShelfFilter.gain.value=db; highShelfFilter.gain.value=db; } }

        // --- FIXED DRAW FUNCTION ---
        function draw() {
            if (state.isRunning) {
                animationId = requestAnimationFrame(draw);
            }
            
            const cvs = els.oscilloscope;
            const ctx = els.ctx;
            const w = cvs.width;
            const h = cvs.height;

            ctx.clearRect(0, 0, w, h);

            // Safe Data Update
            if (state.isRunning && analyser && analyser.frequencyBinCount > 0) {
                if (!capturedWaveform || capturedWaveform.length !== analyser.frequencyBinCount) {
                    capturedWaveform = new Uint8Array(analyser.frequencyBinCount);
                }
                analyser.getByteTimeDomainData(capturedWaveform);
            }

            // 1. Flat Line if no data
            if (!capturedWaveform) {
                ctx.lineWidth = 2;
                ctx.strokeStyle = '#334155';
                ctx.beginPath();
                ctx.moveTo(0, h/2);
                ctx.lineTo(w, h/2);
                ctx.stroke();
                return;
            }

            const bufLen = capturedWaveform.length;

            // 2. Megaphone logic
            if (state.mode === 'megaphone') {
                let sum=0; for(let i=0; i<bufLen; i++) sum+=((capturedWaveform[i]-128)/128)**2;
                const rms = Math.sqrt(sum/bufLen); const db = Math.max(0, Math.round(20*Math.log10(rms+1e-5)+100));
                els.dbBarFill.style.width = Math.min(100, db)+"%"; els.dbCurrent.textContent = db+" dB";
                if(db>state.maxDb) { state.maxDb=db; els.dbMax.textContent=db+" dB"; } 
                return;
            }

            // 3. Waveform Draw
            ctx.lineWidth = 3; 
            ctx.strokeStyle = '#10b981'; 
            ctx.beginPath(); 
            
            let trigger = 0;
            for(let i=0; i<bufLen/2; i++) if(capturedWaveform[i]<=128 && capturedWaveform[i+1]>128 && (capturedWaveform[i+1]-capturedWaveform[i])>2) { trigger=i; break; }
            
            const slice = w / 512; 
            let x = 0;
            for(let i=0; i<512; i++) { 
                const v = (capturedWaveform[trigger+i] || 128) / 128.0; 
                const y = v * h/2; 
                if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y); 
                x+=slice; 
            }
            ctx.stroke();

            // 4. Pitch Update
            if (state.isRunning) {
                if (state.labSource==='generator') {
                     updateNote(els.sliderFreq.value);
                } else { 
                     const p = autoCorrelate(capturedWaveform, audioCtx.sampleRate); 
                     if(p!==-1) updateNote(p); 
                }
            }
        }
        
        // ... (Rest of physics functions remain unchanged) ...
        // For brevity, keeping existing helper functions in script.js context
        // They are included in previous blocks and didn't need changing.
        
        function updateSpeedPhysics() {
            let v = 0; const T = state.temp; const m = state.medium; let name = "";
            if (m === 'air') { v = 331.5 + 0.607 * T; name = `æ°£é«” (ç©ºæ°£ ${T}Â°C)`; } 
            else if (m === 'water') { v = 1404.3 + 4.7 * T - 0.04 * T * T; name = `æ¶²é«” (æ°´ ${T}Â°C)`; } 
            else if (m === 'iron') { v = 5130 - 0.5 * T; name = `å›ºé«” (éµ ${T}Â°C)`; }
            state.calculatedSpeed = Math.round(v); els.speedVal.textContent = `${state.calculatedSpeed} m/s`; els.speedMediumLabel.textContent = `ä»‹è³ª: ${name}`;
        }
        function initParticles() {
            particles = []; els.speedCanvas.width = els.speedCanvas.parentElement.clientWidth; els.speedCanvas.height = els.speedCanvas.parentElement.clientHeight;
            const w = els.speedCanvas.width; const h = els.speedCanvas.height; let count = 50;
            if (state.medium === 'air') count = 40; else if (state.medium === 'water') count = 150; else { const cols=15, rows=8, spX=w/cols, spY=h/rows; for(let i=0;i<cols;i++) for(let j=0;j<rows;j++) particles.push({x: i*spX+spX/2, y: j*spY+spY/2, bx: i*spX+spX/2, by: j*spY+spY/2, type: 'grid'}); return; }
            for(let i=0; i<count; i++) particles.push({x: Math.random()*w, y: Math.random()*h, bx:0, by:0, type: 'rand'}); particles.forEach(p=>{p.bx=p.x; p.by=p.y;});
        }
        function drawSpeedLoop() {
            if (state.mode !== 'speed') return;
            requestAnimationFrame(drawSpeedLoop);
            const w = els.speedCanvas.width; const h = els.speedCanvas.height; const ctx = els.speedCtx;
            ctx.fillStyle = '#020617'; ctx.fillRect(0, 0, w, h);
            ctx.fillStyle = state.medium === 'iron' ? '#94a3b8' : (state.medium === 'water' ? '#38bdf8' : '#cbd5e1');
            particles.forEach(p => {
                let dx = 0; if (state.isPulseRunning) { const dist = Math.abs(p.bx - state.pulseX); if (dist < 30) { dx = Math.sin((dist/30)*Math.PI) * 10; if (p.bx < state.pulseX) dx = -dx * 0.5; } }
                let jx=0, jy=0; if (state.medium === 'air') { jx = (Math.random()-0.5)*2; jy = (Math.random()-0.5)*2; } if (state.medium === 'water') { jx = (Math.random()-0.5); jy = (Math.random()-0.5); } if (state.medium === 'iron') { jx = (Math.random()-0.5)*0.2; jy = (Math.random()-0.5)*0.2; }
                ctx.beginPath(); ctx.arc(p.bx + dx + jx, p.by + jy, state.medium==='air'?3:4, 0, Math.PI*2); ctx.fill();
            });
            if (state.isPulseRunning) { const pixSpeed = state.calculatedSpeed * 0.015; state.pulseX += pixSpeed; ctx.strokeStyle = 'rgba(255, 255, 255, 0.3)'; ctx.lineWidth = 2; ctx.beginPath(); ctx.moveTo(state.pulseX, 0); ctx.lineTo(state.pulseX, h); ctx.stroke(); if (state.pulseX > w + 50) state.isPulseRunning = false; }
        }
        function startMetronome() { initAudio(); stopAll(); state.nextNoteTime = audioCtx.currentTime; state.currentBeatCount = 0; state.isRunning = true; els.btnMetroToggle.innerHTML = "<span>â¹ åœæ­¢</span>"; els.btnMetroToggle.classList.replace('bg-violet-600', 'bg-red-500'); els.btnMetroToggle.classList.replace('hover:bg-violet-500', 'hover:bg-red-600'); metroScheduler(); }
        function metroScheduler() { if (!state.isRunning) return; while (state.nextNoteTime < audioCtx.currentTime + state.scheduleAheadTime) { scheduleNote(state.nextNoteTime); nextNote(); } state.metroTimerID = setTimeout(metroScheduler, state.lookahead); }
        function nextNote() { const secondsPerBeat = 60.0 / state.bpm; state.nextNoteTime += secondsPerBeat; state.currentBeatCount++; }
        function scheduleNote(time) { const beatIndex = state.currentBeatCount % state.beatsPerMeasure; const isAccent = (beatIndex === 0); const beatNum = beatIndex + 1; const osc = audioCtx.createOscillator(); const gain = audioCtx.createGain(); osc.connect(gain); gain.connect(audioCtx.destination); if (state.metroSound === 'digital') { osc.frequency.value = isAccent ? 1500 : 1000; osc.type = 'sine'; gain.gain.setValueAtTime(1, time); gain.gain.exponentialRampToValueAtTime(0.001, time + 0.1); } else { osc.frequency.value = isAccent ? 1200 : 800; osc.type = 'square'; gain.gain.setValueAtTime(0.5, time); gain.gain.exponentialRampToValueAtTime(0.001, time + 0.05); } osc.start(time); osc.stop(time + 0.1); const delay = (time - audioCtx.currentTime) * 1000; setTimeout(() => { if(state.isRunning) { els.metroBeatNum.textContent = beatNum; const activeClass = isAccent ? 'active-strong' : 'active-weak'; els.metroVisual.classList.add(activeClass); setTimeout(() => els.metroVisual.classList.remove(activeClass), 100); } }, delay); }
        function handleTapTempo() { const now = Date.now(); state.tapTimes = state.tapTimes.filter(t => now - t < 2000); state.tapTimes.push(now); if (state.tapTimes.length > 1) { let intervals = []; for (let i = 1; i < state.tapTimes.length; i++) intervals.push(state.tapTimes[i] - state.tapTimes[i-1]); const avg = intervals.reduce((a,b)=>a+b) / intervals.length; const bpm = Math.round(60000 / avg); if (bpm >= 30 && bpm <= 250) { state.bpm = bpm; els.sliderBpm.value = bpm; els.bpmDisplay.textContent = bpm; } } }
        function startDoppler() { initAudio(); stopAll(); state.isRunning = true; state.dopSrcX = -50; state.dopWaves = []; state.frameCount = 0; els.btnDopplerToggle.innerHTML = "<span>â¹ åœæ­¢æ¨¡æ“¬</span>"; els.btnDopplerToggle.classList.replace('bg-pink-600', 'bg-red-500'); els.btnDopplerToggle.classList.replace('hover:bg-pink-500', 'hover:bg-red-600'); oscillator = audioCtx.createOscillator(); gainNode = audioCtx.createGain(); oscillator.type = 'sawtooth'; oscillator.connect(gainNode); gainNode.connect(audioCtx.destination); oscillator.start(); drawDopplerLoop(); }
        function initDopplerView() { state.dopSrcX = 50; state.dopWaves = []; state.frameCount = 0; const w = els.dopplerCanvas.width; state.dopObsX = w/2; drawDopplerFrame(); }
        function drawDopplerLoop() { if (!state.isRunning) return; animationId = requestAnimationFrame(drawDopplerLoop); state.frameCount++; const w = els.dopplerCanvas.width; state.dopObsX = w/2; const C = 3.0; const vRatio = state.dopVel / 1235; const vPx = vRatio * C; state.dopSrcX += vPx; if (state.dopSrcX > w + 100) { state.dopSrcX = -100; state.dopWaves = []; } if (state.frameCount % 8 === 0) state.dopWaves.push({x: state.dopSrcX, r: 0}); state.dopWaves.forEach(wave => wave.r += C); state.dopWaves = state.dopWaves.filter(wave => wave.r < w * 1.5); let obsFreq = state.dopBaseFreq; if (vRatio > 0) { if (state.dopSrcX < state.dopObsX) obsFreq = state.dopBaseFreq * (1 / (1 - vRatio)); else obsFreq = state.dopBaseFreq * (1 / (1 + vRatio)); } if (obsFreq > 3000) obsFreq = 3000; if (obsFreq < 0) obsFreq = 0; if (oscillator) { oscillator.frequency.setTargetAtTime(obsFreq, audioCtx.currentTime, 0.1); const dist = Math.abs(state.dopSrcX - state.dopObsX); let vol = 1 - (dist / w); if (vol < 0) vol = 0; const masterVol = state.dopVol / 100; gainNode.gain.setTargetAtTime(vol * masterVol * 0.5, audioCtx.currentTime, 0.1); } els.dopObsFreq.textContent = Math.round(obsFreq); drawDopplerFrame(); }
        function drawDopplerFrame() { const ctx = els.dopCtx; const w = els.dopplerCanvas.width; const h = els.dopplerCanvas.height; ctx.fillStyle = '#020617'; ctx.fillRect(0, 0, w, h); ctx.lineWidth = 2; state.dopWaves.forEach(wave => { const alpha = Math.max(0, 1 - wave.r / (w * 0.8)); ctx.strokeStyle = `rgba(56, 189, 248, ${alpha})`; ctx.beginPath(); ctx.arc(wave.x, h/2, wave.r, 0, Math.PI*2); ctx.stroke(); }); ctx.font = '40px serif'; ctx.textAlign = 'center'; ctx.textBaseline = 'middle'; ctx.fillText('ğŸ‘‚', state.dopObsX, h/2); ctx.fillStyle = '#10b981'; ctx.font = '12px sans-serif'; ctx.fillText('è§€å¯Ÿè€…', state.dopObsX, h/2 + 35); ctx.save(); ctx.translate(state.dopSrcX, h/2); ctx.scale(-1, 1); ctx.font = '40px serif'; ctx.textAlign = 'center'; ctx.textBaseline = 'middle'; ctx.fillText('ğŸš‘', 0, 0); ctx.restore(); ctx.fillStyle = '#ec4899'; ctx.font = '12px sans-serif'; ctx.textAlign = 'center'; ctx.fillText('è²æº', state.dopSrcX, h/2 + 35); }
        function startSonicBoom() { stopAll(); state.isRunning = true; state.sbWaves = []; state.sbSourceX = -150; state.frameCount = 0; els.btnSbToggle.innerHTML = "<span>â¹ åœæ­¢æ¨¡æ“¬</span>"; els.btnSbToggle.classList.replace('bg-rose-600', 'bg-red-500'); els.btnSbToggle.classList.replace('hover:bg-rose-500', 'hover:bg-red-600'); drawSonicBoomLoop(); }
        function initSonicBoomView() { state.sbSourceX = -150; state.sbWaves = []; drawSonicBoomFrame(); }
        function drawSonicBoomLoop() { if (!state.isRunning) return; animationId = requestAnimationFrame(drawSonicBoomLoop); state.frameCount++; const w = els.sonicboomCanvas.width; const h = els.sonicboomCanvas.height; const soundSpeed = 3; const sourceSpeed = soundSpeed * state.sbMach; state.sbSourceX += sourceSpeed; if (state.sbSourceX > w + 150) { state.sbSourceX = -150; state.sbWaves = []; } if (state.frameCount % 15 === 0) { state.sbWaves.push({ x: state.sbSourceX, y: h/2, r: 0, opacity: 1 }); } state.sbWaves.forEach(wave => { wave.r += soundSpeed; wave.opacity = Math.max(0, 1 - wave.r / (w * 0.8)); }); state.sbWaves = state.sbWaves.filter(w => w.opacity > 0); drawSonicBoomFrame(); }
        function drawSonicBoomFrame() { const ctx = els.sbCtx; const w = els.sonicboomCanvas.width; const h = els.sonicboomCanvas.height; ctx.fillStyle = '#020617'; ctx.fillRect(0, 0, w, h); if (state.sbMach >= 1.0) { const angle = Math.asin(1 / state.sbMach); const coneLen = w * 1.5; ctx.save(); ctx.translate(state.sbSourceX, h/2); ctx.beginPath(); ctx.strokeStyle = 'rgba(255, 255, 255, 0.3)'; ctx.lineWidth = 2; ctx.setLineDash([5, 5]); ctx.moveTo(0, 0); ctx.lineTo(-coneLen * Math.cos(angle), -coneLen * Math.sin(angle)); ctx.moveTo(0, 0); ctx.lineTo(-coneLen * Math.cos(angle), coneLen * Math.sin(angle)); ctx.stroke(); ctx.restore(); } ctx.lineWidth = 2; state.sbWaves.forEach(wave => { ctx.strokeStyle = `rgba(244, 63, 94, ${wave.opacity})`; ctx.beginPath(); ctx.arc(wave.x, wave.y, wave.r, 0, Math.PI * 2); ctx.stroke(); }); ctx.fillStyle = '#f43f5e'; ctx.beginPath(); ctx.moveTo(state.sbSourceX + 15, h/2); ctx.lineTo(state.sbSourceX - 10, h/2 - 8); ctx.lineTo(state.sbSourceX - 10, h/2 + 8); ctx.fill(); ctx.fillStyle = '#fff'; ctx.font = '12px sans-serif'; ctx.textAlign = 'center'; ctx.fillText(`M ${state.sbMach}`, state.sbSourceX, h/2 - 20); }
        function startResonance() { stopAll(); state.isRunning = true; state.resTime = 0; state.resMassY = 0; state.resVelY = 0; state.resHistory = []; els.btnResToggle.innerHTML = "<span>â¹ åœæ­¢å¯¦é©—</span>"; els.btnResToggle.classList.replace('bg-yellow-600', 'bg-red-500'); els.btnResToggle.classList.replace('hover:bg-yellow-500', 'hover:bg-red-600'); els.resWarning.classList.add('hidden'); drawResonanceLoop(); }
        function initResonanceView() { state.resTime = 0; state.resMassY = 0; state.resVelY = 0; state.resHistory = []; drawResonanceFrame(); }
        function drawResonanceLoop() { if (!state.isRunning) return; animationId = requestAnimationFrame(drawResonanceLoop); const subSteps = 5; const dt = 0.016 / subSteps; for (let i = 0; i < subSteps; i++) { state.resTime += dt; const w0 = 2 * Math.PI * state.resNaturalFreq; const w = 2 * Math.PI * state.resDriveFreq; const zeta = state.resDamping; const F0_m = 1500; const force = F0_m * Math.cos(w * state.resTime); const dampingForce = -2 * zeta * w0 * state.resVelY; const restoringForce = -w0 * w0 * state.resMassY; const acc = force + dampingForce + restoringForce; state.resVelY += acc * dt; state.resMassY += state.resVelY * dt; } if (state.resHistory.length > 300) state.resHistory.shift(); const currentAmp = Math.abs(state.resMassY); state.resHistory.push(currentAmp); if (currentAmp > 120) { if(els.resWarning) els.resWarning.classList.remove('hidden'); } else { if(els.resWarning) els.resWarning.classList.add('hidden'); } drawResonanceFrame(); }
        function drawResonanceFrame() { const w = els.resonanceCanvas.width; const h = els.resonanceCanvas.height; const ctx = els.resCtx; const gCtx = els.resGraphCtx; ctx.fillStyle = '#0f172a'; ctx.fillRect(0, 0, w, h); const centerX = w / 2; const centerY = h / 2; const driverYPos = centerY - 100 + (20 * Math.cos(2 * Math.PI * state.resDriveFreq * state.resTime)); const massYPos = centerY + 50 + state.resMassY; ctx.strokeStyle = '#94a3b8'; ctx.lineWidth = 4; ctx.beginPath(); ctx.moveTo(centerX, driverYPos); const coils = 10; const springLen = massYPos - driverYPos; for(let i=0; i<=coils; i++) { const y = driverYPos + (springLen/coils) * i; const xOffset = (i%2===0) ? 0 : (i%4===1 ? 15 : -15); ctx.lineTo(centerX + xOffset, y); } ctx.lineTo(centerX, massYPos); ctx.stroke(); ctx.fillStyle = '#eab308'; ctx.fillRect(centerX - 30, driverYPos - 10, 60, 20); ctx.fillStyle = '#fff'; ctx.font = '10px sans-serif'; ctx.fillText('Driver', centerX - 15, driverYPos + 4); const amp = Math.min(Math.abs(state.resMassY) / 80, 1); const r = Math.round(16 + amp * 230); const g = Math.round(185 - amp * 185); const b = Math.round(129 - amp * 129); ctx.fillStyle = `rgb(${r},${g},${b})`; ctx.beginPath(); ctx.arc(centerX, massYPos, 25, 0, Math.PI * 2); ctx.fill(); ctx.stroke(); gCtx.fillStyle = '#020617'; gCtx.fillRect(0, 0, els.resonanceGraph.width, els.resonanceGraph.height); gCtx.beginPath(); gCtx.strokeStyle = '#10b981'; gCtx.lineWidth = 2; const gw = els.resonanceGraph.width; const gh = els.resonanceGraph.height; if (state.resHistory.length > 0) { gCtx.moveTo(0, gh); for(let i=0; i<state.resHistory.length; i++) { const x = (i / 300) * gw; const y = gh - (state.resHistory[i] / 100) * gh; gCtx.lineTo(x, y); } gCtx.stroke(); } gCtx.strokeStyle = 'rgba(255, 255, 255, 0.2)'; gCtx.setLineDash([5,5]); gCtx.beginPath(); gCtx.moveTo(0, gh * 0.2); gCtx.lineTo(gw, gh * 0.2); gCtx.stroke(); gCtx.setLineDash([]); }
        function startUltrasoundPulse() { if (state.usPulseState !== 0) return; state.usPulseState = 1; state.usPulseX = 50; state.isRunning = true; state.usMeasuredDist = null; state.usWaves = []; els.usDistVal.textContent = "---"; els.usTimeVal.textContent = "---"; els.sliderUsDist.disabled = true; initAudio(); const osc = audioCtx.createOscillator(); const g = audioCtx.createGain(); osc.connect(g); g.connect(audioCtx.destination); osc.frequency.value = 800; osc.type = 'sine'; g.gain.setValueAtTime(0.3, audioCtx.currentTime); g.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.1); osc.start(); osc.stop(audioCtx.currentTime + 0.1); state.usWaves = [{ x: 50, r: 10, opacity: 1.0, dir: 1, active: true }, { x: 40, r: 15, opacity: 0.8, dir: 1, active: true }]; drawUltrasoundLoop(); }
        function drawUltrasoundLoop() { if (state.usPulseState === 0) { state.isRunning = false; els.sliderUsDist.disabled = false; return; } requestAnimationFrame(drawUltrasoundLoop); const w = els.ultrasoundCanvas.width; const startX = 50; const maxDistCm = 200; const scalePx = (w - 100) / maxDistCm; const targetX = startX + state.usTargetDist * scalePx; const speedPx = 8; let packetFrontX = state.usPulseState === 1 ? -999 : 999; state.usWaves.forEach(wave => { if (!wave.active) return; wave.x += speedPx * wave.dir; if (state.usPulseState === 1 && wave.x > packetFrontX) packetFrontX = wave.x; if (state.usPulseState === 2 && wave.x < packetFrontX) packetFrontX = wave.x; }); if (state.usPulseState === 1 && packetFrontX >= targetX) { state.usPulseState = 2; state.usWaves = [{ x: targetX, r: 10, opacity: 1.0, dir: -1, active: true }, { x: targetX + 10, r: 15, opacity: 0.8, dir: -1, active: true }]; drawUltrasoundFrame(true); return; } else if (state.usPulseState === 2 && packetFrontX <= startX) { state.usPulseState = 0; state.usWaves = []; const speedCmPerSec = 34300; const distCm = state.usTargetDist; const timeSec = (distCm * 2) / speedCmPerSec; state.usMeasuredDist = distCm; els.usDistVal.textContent = distCm.toFixed(1); els.usTimeVal.textContent = (timeSec * 1000).toFixed(2); if(audioCtx) { const osc = audioCtx.createOscillator(); const g = audioCtx.createGain(); osc.connect(g); g.connect(audioCtx.destination); osc.frequency.value = 1200; g.gain.setValueAtTime(0.3, audioCtx.currentTime); g.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.1); osc.start(); osc.stop(audioCtx.currentTime + 0.1); } drawUltrasoundFrame(); return; } drawUltrasoundFrame(); }
        function drawUltrasoundFrame(flash = false) { const ctx = els.usCtx; const w = els.ultrasoundCanvas.width; const h = els.ultrasoundCanvas.height; ctx.fillStyle = '#020617'; ctx.fillRect(0, 0, w, h); ctx.strokeStyle = '#334155'; ctx.beginPath(); ctx.moveTo(50, h/2); ctx.lineTo(w-50, h/2); ctx.stroke(); const startX = 50; const maxDistCm = 200; const scalePx = (w - 100) / maxDistCm; const targetX = startX + state.usTargetDist * scalePx; ctx.fillStyle = flash ? '#ffffff' : '#ef4444'; ctx.fillRect(targetX, h/2 - 40, 20, 80); ctx.fillStyle = '#fff'; ctx.font = '12px sans-serif'; ctx.textAlign = 'center'; ctx.fillText('éšœç¤™ç‰©', targetX + 10, h/2 + 55); ctx.fillStyle = '#06b6d4'; ctx.beginPath(); ctx.arc(startX, h/2, 15, 0, Math.PI*2); ctx.fill(); ctx.fillStyle = '#fff'; ctx.fillText('æ„Ÿæ¸¬å™¨', startX, h/2 + 30); ctx.lineWidth = 3; state.usWaves.forEach(wave => { if (!wave.active) return; const color = wave.dir === 1 ? `rgba(251, 191, 36, ${wave.opacity})` : `rgba(163, 230, 53, ${wave.opacity})`; ctx.strokeStyle = color; ctx.beginPath(); if (wave.dir === 1) ctx.arc(wave.x - 10, h/2, 30, -Math.PI/3, Math.PI/3); else ctx.arc(wave.x + 10, h/2, 30, 2*Math.PI/3, 4*Math.PI/3); ctx.stroke(); }); }
        function updateNote(f){ const freq = parseFloat(f); if (isNaN(freq)) return; els.displayFreq.textContent=freq.toFixed(1)+" Hz"; const m=Math.round(12*Math.log2(freq/440))+69; const noteIdx = m%12; const octave = Math.floor(m/12) - 1; els.displayNote.textContent=(noteStrings[noteIdx] || "--") + (noteStrings[noteIdx] ? octave : ""); els.displaySolfege.textContent=solfegeStrings[noteIdx]||"--"; }
        function autoCorrelate(b,r){ const S=b.length; let rms=0; for(let i=0;i<S;i++) rms+=((b[i]-128)/128)**2; if(Math.sqrt(rms/S)<0.02) return -1; let r1=0,r2=S-1; for(let i=0;i<S/2;i++) if(Math.abs((b[i]-128)/128)<0.2){r1=i;break;} for(let i=1;i<S/2;i++) if(Math.abs((b[S-i]-128)/128)<0.2){r2=S-i;break;} const b2=b.slice(r1,r2); const c=new Array(b2.length).fill(0); for(let i=0;i<c.length;i++) for(let j=0;j<c.length-i;j++) c[i]+=((b2[j]-128)/128)*((b2[j+i]-128)/128); let d=0; while(c[d]>c[d+1])d++; let mv=-1,mp=-1; for(let i=d;i<c.length;i++) if(c[i]>mv){mv=c[i];mp=i;} return r/mp; }
    </script>
</body>
</html>